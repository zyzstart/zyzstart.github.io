<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>RPC | Michael的小木屋</title><meta name="keywords" content="play hard work hard"><meta name="author" content="Michael"><meta name="copyright" content="Michael"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="RPC">
<meta property="og:type" content="article">
<meta property="og:title" content="RPC">
<meta property="og:url" content="http://example.com/2023/03/22/Rpc/index.html">
<meta property="og:site_name" content="Michael的小木屋">
<meta property="og:description" content="RPC">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http:///p0.qhimg.com/t011e52abaa7f71c4b7.jpg">
<meta property="article:published_time" content="2023-03-21T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-21T05:02:47.509Z">
<meta property="article:author" content="Michael">
<meta property="article:tag" content="play hard work hard">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:///p0.qhimg.com/t011e52abaa7f71c4b7.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/03/22/Rpc/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RPC',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-21 13:02:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http:///p0.qhimg.com/t011e52abaa7f71c4b7.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Michael的小木屋</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RPC</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-03-21T16:00:00.000Z" title="发表于 2023-03-22 00:00:00">2023-03-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-21T05:02:47.509Z" title="更新于 2024-04-21 13:02:47">2024-04-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RPC"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="分布式系列课程–RPC编程"><a href="#分布式系列课程–RPC编程" class="headerlink" title="分布式系列课程–RPC编程"></a>分布式系列课程–RPC编程</h3><h4 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h4><h5 id="1-1-RPC的概念"><a href="#1-1-RPC的概念" class="headerlink" title="1.1 RPC的概念"></a>1.1 RPC的概念</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> RPC是远程调用（Remote Procedure Call)的缩写形式，是一种跨进程（JVM)的方法调用形式。是目前在Java分布式，微服务体系中，重要的一种通信方式。</span><br></pre></td></tr></table></figure>

<h5 id="1-2-架构的演变过程"><a href="#1-2-架构的演变过程" class="headerlink" title="1.2 架构的演变过程"></a>1.2 架构的演变过程</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单体架构</span><br><span class="line">1.1单体架构 --- 水平扩展</span><br><span class="line"><span class="bullet">2.</span> 垂直架构 --- 垂直划分 垂直扩展</span><br><span class="line"><span class="bullet">3.</span> RPC架构</span><br></pre></td></tr></table></figure>

<h6 id="1-单体架构"><a href="#1-单体架构" class="headerlink" title="1. 单体架构"></a>1. 单体架构</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 也叫做单体应用：就是系统中所有的功能（代码）耦合在了一起。并且生成一个jar[war]。部署在一个tomcat中（JVM一个进程）</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230221211431702.png" alt="image-20230221211431702"></p>
<h6 id="2-单体架构存在的问题"><a href="#2-单体架构存在的问题" class="headerlink" title="2. 单体架构存在的问题"></a>2. 单体架构存在的问题</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 热点问题（某个子系统访问量大，导致其他子系统的访问出现问题）</span><br><span class="line"><span class="bullet">2.</span> 扩展性差，新资源的分配力度不精确（门户系统访问量，增加机器，增加服务器tomcat。但是新增的资源，不能精确给到门户）</span><br><span class="line"><span class="bullet">3.</span> 模块（子系统）耦合度高、相互影响（修改某一个子系统的代码，产生了问题，影响其他的子系统）</span><br><span class="line"><span class="bullet">4.</span> 维护部署成本高（某次发布，只更新了后台管理的（订单模块），但是因为是单体架构，所以会发布整个系统。</span><br><span class="line"><span class="bullet">5.</span> 技术栈受限，必须使用相同的编程语言开发不同的子系统。</span><br></pre></td></tr></table></figure>

<h6 id="3-垂直架构"><a href="#3-垂直架构" class="headerlink" title="3. 垂直架构"></a>3. 垂直架构</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 把一个单体架构的应用，按照子系统进行了划分，每个子系统都独立部署在自己的tomcat（JVM 进程）中。多个子系统共享数据库等存储资源。</span><br><span class="line"><span class="bullet">2.</span> 垂直架构做水平扩展。</span><br><span class="line"><span class="bullet">3.</span> 有限的解决了单体架构的部分问题。粒度（子系统）</span><br><span class="line">   热点问题（子系统级别的热点问题解决了，但是模块的热点问题没有解决）。</span><br><span class="line">   扩展性差 (子系统级别，增加机器，资源分配 相对精确)</span><br><span class="line">   子系统耦合度降低，独立的更新，发版。</span><br><span class="line">   维护 部署成本 有所好转</span><br><span class="line">   技术栈也不要求统一语言（门户 PHP,后台管理 Java）</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230221211453388.png" alt="image-20230221211453388"></p>
<h6 id="4-RPC架构"><a href="#4-RPC架构" class="headerlink" title="4. RPC架构"></a>4. RPC架构</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">跨进程调用如何完成。走网络 进行网络编程</span><br><span class="line">Http协议  TCP协议？</span><br><span class="line">  1          2</span><br><span class="line"></span><br><span class="line">如果走Http协议</span><br><span class="line"><span class="bullet">              1.</span>  Http协议对于程序员来讲 最方便的是 不用开发服务器（tomcat,resin,weblogic jboss)</span><br><span class="line"><span class="bullet">              2.</span>  服务器端 , 服务要通过 控制器进行暴露（Servlet Controller)</span><br><span class="line"><span class="bullet">              3.</span>  客户端：http请求（不一定通过浏览器）HttpClient ,OKHttp,RestTemplate WebClient</span><br><span class="line">问题：   1. 包一层 不能直接通过网络调用Service</span><br><span class="line"><span class="bullet">              2.</span> Client代码过于繁琐了 new HttpClient() ---&gt; Get Post  HttpGet HttpPost。不能直接表达业务含义。</span><br><span class="line"><span class="bullet">              3.</span> 走Http协议 传输数据 数据量大 。 慢</span><br><span class="line">典型的技术实现方案：1 SpringCloud Feign  2 Hession RPC</span><br><span class="line"><span class="code">              优势  Http协议 文本类型 字符串协议 跨语言平台好。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">如果走TCP协议</span><br><span class="line"><span class="code">             明确  跨进程间调用的本质是什么？首先 网络通信，网络通信什么？参数 返回值</span></span><br><span class="line"><span class="code">             服务器端 自己开发 Socket NIO  Netty。接受client传递参数，需要调用哪个方法的名字。把结果返回</span></span><br><span class="line"><span class="code">                             好处：可以直接进行Service的调用</span></span><br><span class="line"><span class="code">             客户端自己开发 大量网络相关的代码。接受服务端的返回值</span></span><br><span class="line"><span class="code">             自己定义应用协议 自己使用序列化的方式</span></span><br><span class="line"><span class="code">             好处：效率高（3次握手  4次握手 ） 协议 自定义的 二进制 线程管理好</span></span><br><span class="line"><span class="code">             坏处：开发难度大 对使用者不友好</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">典型的技术实现方案：Dubbo</span><br><span class="line"></span><br><span class="line">2种方案 都可以称之为RPC 跨进程调用。</span><br></pre></td></tr></table></figure>

<h6 id="5-RPC的设计"><a href="#5-RPC的设计" class="headerlink" title="5. RPC的设计"></a>5. RPC的设计</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 设计目标：让调用者像调用本地方法那样，去调用远端的服务方法。</span><br><span class="line"><span class="bullet">2.</span> RPC设计过程中解决的核心问题：</span><br><span class="line"> </span><br><span class="line"><span class="bullet">   1.</span> 通信方式 TCP(Socket NIO Netty Mina)  Http</span><br><span class="line"><span class="bullet">   2.</span> TCP(自定义协议）</span><br><span class="line"><span class="bullet">   3.</span> 序列化 （JSON Protobuf Hessian)</span><br><span class="line"><span class="bullet">   4.</span> 在调用者这方 创建 远端服务类的代理类 </span><br><span class="line"><span class="code">      传输数据 </span></span><br><span class="line"><span class="code">      网络通信</span></span><br><span class="line"><span class="code">      </span></span><br><span class="line"><span class="code">3. 衍生的方案： 注册中心 核心作用 服务的治理 </span></span><br><span class="line"><span class="code">              1. 负载均衡 </span></span><br><span class="line"><span class="code">              2. 健康管理 服务管理 （心跳 重试【延迟队列】）</span></span><br><span class="line"><span class="code">              3. 解耦合</span></span><br><span class="line"><span class="code">              熔断 </span></span><br><span class="line"><span class="code">              限流</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20240421124743958.png" alt="image-20240421124743958"></p>
<h4 id="2-Hessian-RPC"><a href="#2-Hessian-RPC" class="headerlink" title="2. Hessian RPC"></a>2. Hessian RPC</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 为什么要学习</span><br><span class="line">   a.纯粹的RPC,只解决了RPC中的4个核心问题（1，网络通信 2，协议 3，序列化 4，代理）</span><br><span class="line">   b.Java写的</span><br><span class="line">   c.HessianRPC落伍了，但是他的序列化方式，被Dubbo还在使用。</span><br><span class="line"><span class="code">     Dubbo用的Hessian,阿里定制（Hessain Lite) Dubbo中默认启动的。</span></span><br></pre></td></tr></table></figure>

<h5 id="2-1-HessianRPC概念"><a href="#2-1-HessianRPC概念" class="headerlink" title="2.1 HessianRPC概念"></a>2.1 HessianRPC概念</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> Resin服务器的伴生产品。</span><br><span class="line"><span class="bullet">2.</span> 基于Java编程语言设计的RPC框架，只支持Java编程语言使用（服务的调用者，服务的提供者都得是Java开发)</span><br><span class="line"><span class="bullet">3.</span> 序列化协议 二级制 </span><br><span class="line"><span class="bullet">4.</span> 官网 http://hessian.caucho.com/doc/</span><br></pre></td></tr></table></figure>

<h5 id="2-2-HessianRPC设计思想"><a href="#2-2-HessianRPC设计思想" class="headerlink" title="2.2 HessianRPC设计思想"></a>2.2 HessianRPC设计思想</h5><p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230223165133798.png" alt="image-20230223165133798"></p>
<h5 id="2-3-HessianRPC的开发"><a href="#2-3-HessianRPC的开发" class="headerlink" title="2.3 HessianRPC的开发"></a>2.3 HessianRPC的开发</h5><h6 id="2-3-1-环境搭建"><a href="#2-3-1-环境搭建" class="headerlink" title="2.3.1 环境搭建"></a>2.3.1 环境搭建</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="2-3-2-开发步骤"><a href="#2-3-2-开发步骤" class="headerlink" title="2.3.2 开发步骤"></a>2.3.2 开发步骤</h6><ul>
<li><p>服务端 （RPC远端功能提供者）</p>
<ul>
<li><p>开发服务</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 开发Service</span><br><span class="line"><span class="bullet">2.</span> DAO --- Mybaits</span><br><span class="line">注意：一定要定义Service的接口，自定义的数据类型实现Serliazliable</span><br></pre></td></tr></table></figure></li>
<li><p>发布服务</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> web.xml进行配置</span><br><span class="line"><span class="bullet">2.</span> 配置HessianServlet</span><br></pre></td></tr></table></figure>

<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>userServiceRPC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.caucho.hessian.server.HessianServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>home-api<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.suns.service.UserService<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>home-class<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.suns.service.UserServiceImpl<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>userServiceRPC<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/userServiceRPC<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>客户端（远端服务的调用者）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> HessianProxyFactory</span><br><span class="line"><span class="number">2.</span> 参数 <span class="number">1</span> 远端服务的接口 <span class="number">2</span> url</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HessianRPCClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MalformedURLException &#123;</span><br><span class="line">        <span class="type">HessianProxyFactory</span> <span class="variable">hessianProxyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianProxyFactory</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建远端RPC服务的代理对象</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:8989/rpc-hessian/userServiceRPC&quot;</span>;</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) hessianProxyFactory.create(UserService.class, URL);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">userServiceRet</span> <span class="operator">=</span> userService.login(<span class="string">&quot;xiaohei&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;userServiceRet value is &#123;&#125; &quot;</span>, userServiceRet);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="2-4-HessianRPC核心源码分析"><a href="#2-4-HessianRPC核心源码分析" class="headerlink" title="2.4 HessianRPC核心源码分析"></a>2.4 HessianRPC核心源码分析</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> HessianRPC client创建代理的方式 JDK Proxy.newProxyInstance()</span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">create</span><span class="params">(Class&lt;?&gt; api, URL url, ClassLoader loader)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (api == <span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;api must not be null for HessianProxyFactory.create()&quot;</span>);</span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    handler = <span class="keyword">new</span> <span class="title class_">HessianProxy</span>(url, <span class="built_in">this</span>, api);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(loader,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; api,</span><br><span class="line">                                                HessianRemoteObject.class &#125;,</span><br><span class="line">                                  handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 代理中   </span><br><span class="line">     通过网络 Http请求 连接 远端RPC服务</span><br><span class="line">     通过流 数据写出去了。</span><br><span class="line">   HessianProxy#invoke()  </span><br><span class="line">     <span class="number">1.</span>通过 URLConnection 进行网络连接 </span><br><span class="line">     <span class="number">2.</span>解析协议 传递数据</span><br></pre></td></tr></table></figure>

<h5 id="2-5-Hessian-序列化"><a href="#2-5-Hessian-序列化" class="headerlink" title="2.5 Hessian 序列化"></a>2.5 Hessian 序列化</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> Hessian他的RPC 已经落伍了 过时</span><br><span class="line"><span class="bullet">2.</span> Hession序列化方式 还在使用 （Dubbo)</span><br><span class="line">   Dubbo用的Hessian,阿里定制（Hessain Lite) Dubbo中默认启动的。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Hessian序列化的目的 就是为了传输数据  基本类型 对象（Seriazable接口）</span></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;/Users/sunshuai/Develop/code/java/idea/rpc-lession/rpc-hessian/test&quot;</span>);</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(outputStream);</span><br><span class="line">        out.writeObject(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;sunshuai&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">        out.flush();</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Hessian反序列化</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;/Users/sunshuai/Develop/code/java/idea/rpc-lession/rpc-hessian/test&quot;</span>);</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(inputStream);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) hessian2Input.readObject();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, user);</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="3-Thrift-RPC"><a href="#3-Thrift-RPC" class="headerlink" title="3. Thrift RPC"></a>3. Thrift RPC</h4><h5 id="3-1-ThriftRPC的引言"><a href="#3-1-ThriftRPC的引言" class="headerlink" title="3.1 ThriftRPC的引言"></a>3.1 ThriftRPC的引言</h5><h6 id="3-1-1-ThriftRPC-特点"><a href="#3-1-1-ThriftRPC-特点" class="headerlink" title="3.1.1 ThriftRPC 特点"></a>3.1.1 ThriftRPC 特点</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> Thrift是一个RPC框架 </span><br><span class="line"><span class="bullet">2.</span> 可以进行异构系统的RPC调用</span><br><span class="line">   什么叫做以后系统 服务的提供者 和 服务的调用者 不同编程语言开发系统。</span><br><span class="line"><span class="bullet">3.</span> 为什么在当前的系统开发中，会存在着异构系统的RPC?</span><br><span class="line"><span class="bullet">   1.</span> 存在异构系统的调用 </span><br><span class="line"><span class="code">      Python ------&gt; Hbase(Java)</span></span><br><span class="line"><span class="code">             thrift</span></span><br><span class="line"><span class="code">   2. 遗留系统的整合 </span></span><br><span class="line"><span class="code">4. 设计一个异构系统的RPC 解决的核心问题是什么？</span></span><br><span class="line"><span class="code">   肯定：异构系统的RPC 没有问题 只要双方 用各自的编程语言实现 网络编程中（client server)建立网络连接，进行通信即可。</span></span><br><span class="line"><span class="code">   挑战：</span></span><br><span class="line"><span class="code">        1. 得需要精通不同编程语言的网络 IO 线程等相关技术内容 （java go python c delphi....)</span></span><br><span class="line"><span class="code">        2. 通信数据的格式，尤其是二进制的格式，得统一处理（中间的格式）</span></span><br></pre></td></tr></table></figure>

<h6 id="3-1-1-ThriftRPC-框架"><a href="#3-1-1-ThriftRPC-框架" class="headerlink" title="3.1.1 ThriftRPC 框架"></a>3.1.1 ThriftRPC 框架</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 基本概念：是apache组织开源的一个顶级异构系统RPC框架,用于完成异构系统的PRC通信。</span><br><span class="line"><span class="code">           多种编程语言 Java C++ PHP Phyton Ruby Node.jsp....</span></span><br><span class="line"><span class="code">           2007 FaceBook Thrift 开源。</span></span><br><span class="line"><span class="code">2. 特点：</span></span><br><span class="line"><span class="code">   1. 跨语言支持 </span></span><br><span class="line"><span class="code">   2. 开发快速 </span></span><br><span class="line"><span class="code">   3. 学习简单 IDL语言 </span></span><br><span class="line"><span class="code">   4. 稳定 </span></span><br><span class="line"><span class="code">   </span></span><br><span class="line"><span class="code">3. Thrift的设计思想</span></span><br><span class="line"><span class="code">   1. 针对于不同的编程语言提供了一个库（jar） </span></span><br><span class="line"><span class="code">      作用：网络通信的代码 协议（序列化）相关的内容  java libthrift </span></span><br><span class="line"><span class="code">   2. IDL语言 中立语言 用于服务发布</span></span><br><span class="line"><span class="code">   3. Thrift命令把IDL语言 自动转换成 你需要的编程语言。</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230226203010291.png" alt="image-20230226203010291"></p>
<h6 id="3-1-2-ThriftRPC安装"><a href="#3-1-2-ThriftRPC安装" class="headerlink" title="3.1.2 ThriftRPC安装"></a>3.1.2 ThriftRPC安装</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 安装的是什么东西</span><br><span class="line">   安装的就是把IDL转换成具体编程语言代码的命令。</span><br><span class="line"><span class="bullet">2.</span> 如何安装</span><br><span class="line">   mac       brew install thrift </span><br><span class="line">   windows   http://www.apache.org/dyn/closer.cgi?path=/thrift/0.18.0/thrift-0.18.0.exe </span><br><span class="line"><span class="code">             https://blog.51cto.com/u_15854865/5810927</span></span><br><span class="line"><span class="code">             </span></span><br><span class="line"><span class="code">   如何验证： thrift -help   thrift --version </span></span><br><span class="line"><span class="code">3. 针对于不同的编程语言 安装库</span></span><br><span class="line"><span class="code">   &lt;dependency&gt;</span></span><br><span class="line"><span class="code">      &lt;groupId&gt;org.apache.thrift&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">      &lt;artifactId&gt;libthrift&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">      &lt;version&gt;0.18.0&lt;/version&gt;</span></span><br><span class="line"><span class="code">   &lt;/dependency&gt;</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">   python  pip install thrift </span></span><br><span class="line"><span class="code">   go</span></span><br></pre></td></tr></table></figure>

<h6 id="3-1-3-IDL语法"><a href="#3-1-3-IDL语法" class="headerlink" title="3.1.3 IDL语法"></a>3.1.3 IDL语法</h6><blockquote>
<p>IDEA 中 Thrift插件，插件目的提示 校验IDL语法。</p>
<p>IDL语法 必须 thrift</p>
</blockquote>
<ul>
<li><p>注释</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#    单行注释</span><br><span class="line">//   单行注释</span><br><span class="line">/*</span><br><span class="line">*    多行注释 </span><br><span class="line">*/</span><br></pre></td></tr></table></figure></li>
<li><p>namespace</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">namespace java com.suns</span><br><span class="line">namespace py com.suns</span><br><span class="line"></span><br><span class="line">指定生成好的代码 包 </span><br></pre></td></tr></table></figure></li>
<li><p>基本类型</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span>  i8      有符号的8位整数   byte</span><br><span class="line"><span class="bullet">2.</span>  i16     有符号的16位整数  short</span><br><span class="line"><span class="bullet">3.</span>  i32     有符号的32位整数  int</span><br><span class="line"><span class="bullet">4.</span>  i64     有符号的64位整数  long</span><br><span class="line"><span class="bullet">5.</span>  double  64位浮点数       double</span><br><span class="line"><span class="bullet">6.</span>  bool    布尔值          boolean</span><br><span class="line"><span class="bullet">7.</span>  string  字符串 字符      &quot;&quot; &#x27;&#x27;  UTF-8</span><br></pre></td></tr></table></figure></li>
<li><p>集合类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">list&lt;T&gt;   有序可重复    java.util.List </span><br><span class="line">set&lt;T&gt;    无需不可重复  java.util.Set</span><br><span class="line">map&lt;K,V&gt;  k-v         java.util.Map</span><br><span class="line"></span><br><span class="line">map&lt;i32,string&gt; sex = &#123;1:&#x27;female&#x27;,2:&#x27;male&#x27;&#125;</span><br><span class="line">list&lt;i32&gt; ages = [1,2,3,4]</span><br></pre></td></tr></table></figure></li>
<li><p>struct 自定义对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct User&#123;</span><br><span class="line">   1: string name =&#x27;sunshuai&#x27;,</span><br><span class="line">   2: optional i32 age,</span><br><span class="line">   3: list&lt;i32&gt; ages = [1,2,3,4]，</span><br><span class="line">   4. required i32 hieght</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">1. struts 不能继承</span><br><span class="line">2. 成员与成员的分割，；</span><br><span class="line">3. 结构体里面的每一个字段 都要进行编号</span><br><span class="line">4. 变量类型 变量名</span><br><span class="line">5. optional 可选的 默认为每一个成员都加入的关键字</span><br><span class="line">   代表这个字段在序列化过程中可选的。如果这个字段没有默认值，就不序列化，如果有默认值 就序列化.</span><br><span class="line">6. required 比选</span><br></pre></td></tr></table></figure></li>
<li><p>枚举 （enum)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enum SEASON&#123;</span><br><span class="line">   SPRING = 1,</span><br><span class="line">   SUMMERT = 2</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">不支持嵌套，i32 </span><br></pre></td></tr></table></figure></li>
<li><p>异常 （Exception)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exception MyException&#123;</span><br><span class="line">   1: i32 errorCode</span><br><span class="line">   2: string message</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>服务 （Service)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">服务接口 </span><br><span class="line">service UserService&#123;</span><br><span class="line">   bool login(1:string name,2:string password)</span><br><span class="line">   void register(1:User user) //User idl语言中的结构体 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">  1. 异常</span><br><span class="line">     service UserService&#123;</span><br><span class="line">        bool login(1:string name,2:string password) throws (1:MyException e,2:XXXException e)</span><br><span class="line">        void register(1:User user) //User idl语言中的结构体 </span><br><span class="line">      &#125;</span><br><span class="line">  2. oneway 表示客户端发起请求后不等待响应返回,只能和void 这种操作配合。</span><br><span class="line">      service UserService&#123;</span><br><span class="line">        bool login(1:string name,2:string password) throws (1:MyException e,2:XXXException e)</span><br><span class="line">        oneway void register(1:User user) //User idl语言中的结构体 </span><br><span class="line">      &#125;</span><br><span class="line">  3. 继承</span><br><span class="line">     service BaseService&#123;</span><br><span class="line">        void m1(1:string name)</span><br><span class="line">     &#125;</span><br><span class="line">     service UserService extends BaseService&#123;</span><br><span class="line">        </span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>include</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">作用：进行IDL模块化编程</span><br><span class="line"></span><br><span class="line">suns1.thrift</span><br><span class="line">   struct User&#123;</span><br><span class="line">      1:string name</span><br><span class="line">   &#125;</span><br><span class="line">suns2.thrift </span><br><span class="line">   include &quot;suns1.thrift&quot;</span><br><span class="line">   </span><br><span class="line">   service UserService&#123;</span><br><span class="line">     void register(1:suns1.User user)</span><br><span class="line">   </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Thrift把IDL生成对应代码的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">thrift --gen java xx.thrift </span><br><span class="line">thrift --gen py xx.thrift</span><br><span class="line"></span><br><span class="line">thrift -r --gen java xx.thrift </span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="3-1-4-Thrift-RPC的开发"><a href="#3-1-4-Thrift-RPC的开发" class="headerlink" title="3.1.4 Thrift RPC的开发"></a>3.1.4 Thrift RPC的开发</h6><ul>
<li><p>环境搭建</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 安装Thrift 作用：把IDL语言描述的接口内容，生成对应编程语言的代码，简化开发。</span><br><span class="line"><span class="bullet">2.</span> 引入依赖    作用：引入thrift针对于某一种编程语言的封装 （网络通信 协议【序列化】）</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="code">      &lt;groupId&gt;org.apache.thrift&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">      &lt;artifactId&gt;libthrift&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">      &lt;version&gt;0.13.0&lt;/version&gt;</span></span><br><span class="line"><span class="code">   &lt;/dependency&gt;</span></span><br><span class="line"><span class="code">   </span></span><br><span class="line"><span class="code">  &lt;dependency&gt;</span></span><br><span class="line"><span class="code">          &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">          &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">          &lt;version&gt;1.7.32&lt;/version&gt;</span></span><br><span class="line"><span class="code">      &lt;/dependency&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    &lt;dependency&gt;</span></span><br><span class="line"><span class="code">        &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">        &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">        &lt;version&gt;1.2.9&lt;/version&gt;</span></span><br><span class="line"><span class="code">    &lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>项目结构的定义</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> thrift-client  代表的是服务的调用者</span><br><span class="line"><span class="bullet">2.</span> thrift-server  代表的是服务的提供者</span><br><span class="line"><span class="bullet">3.</span> thrift-common  RPC编程共有的内容 1，实体类型 2，服务接口</span><br></pre></td></tr></table></figure></li>
<li><p>Thrift核心对象</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> TTransport</span><br><span class="line">   作用：底层封装网络通信</span><br><span class="line">   TSocket 阻塞IO通信</span><br><span class="line">   TNonblockdingTransport 非阻塞网络通信</span><br><span class="line">   TFramedTransport 加入了封帧的操作 （压缩后 数据边界问题）  </span><br><span class="line"><span class="bullet">2.</span> TProtocol</span><br><span class="line">   处理的协议 （序列化方式）</span><br><span class="line">   TBinayProtocol 二进制进行序列化</span><br><span class="line">   TCompactProtocol 压缩方式 处理二进制 </span><br><span class="line">   TJSONProtocol  JSON进行序列化</span><br><span class="line"><span class="bullet">3.</span> TProcessor</span><br><span class="line">   业务处理：把通信数据 和 业务功能整合在一起</span><br><span class="line"><span class="bullet">4.</span> TServer 服务端</span><br></pre></td></tr></table></figure></li>
<li><p>thrift-common</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 通过IDL语言 定义 client与服务端 共用的数据类型 和 服务接口 </span><br><span class="line"><span class="bullet">2.</span> client server端 引入 common模块</span><br></pre></td></tr></table></figure></li>
<li><p>服务端</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 实现服务接口 ：idl语言生成的</span><br><span class="line"><span class="bullet">2.</span> 创建服务端代码</span><br></pre></td></tr></table></figure></li>
<li><p>客户端</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端要想本地方法那样 调用远端方法。 代理</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="3-1-5-实战开发中的思考"><a href="#3-1-5-实战开发中的思考" class="headerlink" title="3.1.5 实战开发中的思考"></a>3.1.5 实战开发中的思考</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在实战开发中，往往服务端的功能 其实已经开发完成。</span><br><span class="line"><span class="bullet">   1.</span> 现有本地的功能 服务端的功能 写好了。</span><br><span class="line"><span class="bullet">   2.</span> 根据系统的功能，才有可能决定 这个服务发布成 RPC。</span><br><span class="line">   </span><br><span class="line">所以在发布RPC业务实现 IFace接口，主要通过原有的Service方法的调用，进行实现。这样维护性更好，也是实战中使用的方式。</span><br></pre></td></tr></table></figure>

<h6 id="3-1-6TServer服务的相关内容"><a href="#3-1-6TServer服务的相关内容" class="headerlink" title="3.1.6TServer服务的相关内容"></a>3.1.6TServer服务的相关内容</h6><ul>
<li><p>TServer类型</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 带表的是Thrift开发中的服务器。</span><br><span class="line"><span class="bullet">2.</span> 功能：服务的开启serve()   服务的关闭stop()</span><br><span class="line"><span class="bullet">3.</span> 阻塞 非阻塞 有没有线程池 Reactor模式</span><br><span class="line">   TSimpleServer：        阻塞 单线程的服务器 （没有实战价值，只是用于测试）</span><br><span class="line">   TThreadPoolServer:     阻塞 线程池的服务器 </span><br><span class="line">   TNonBlockingServer:    非阻塞单线程的服务器 </span><br><span class="line">   TThreadSelectorServer: 实现了主从版的Reactor(类似Netty)</span><br></pre></td></tr></table></figure></li>
<li><p>分析TSimpleServer</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">目的：1. 了解Thrift相关类型的作用（源码的分析）</span><br><span class="line"><span class="bullet">     2.</span> 核实SimpleServer是一个阻塞的 单线程的服务器</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230303091316205.png" alt="image-20230303091316205"></p>
</li>
<li><p>TThreadPoolServer</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">阻塞，引入了线程池 </span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 如果使用，一定注意 默认的线程池 最大值 Integer.Max显然不成 需要maxWorkerThreads进行设置。</span><br><span class="line"><span class="bullet">2.</span> 不能够让我们的线程复用，因为没有selector</span><br><span class="line"></span><br><span class="line">底层实现思路 </span><br><span class="line">   把具体调用的Socket分配 WorkerProcess进行操作，而WorkerProcess从线程池中获得 线程资源。</span><br></pre></td></tr></table></figure></li>
<li><p>TNonblockingServer</p>
<blockquote>
<p>底层连接 必须使用 TFreameTransport ,TCompactProtocol</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">非阻塞  单线程</span><br><span class="line"></span><br><span class="line">Java NIO </span><br><span class="line"></span><br><span class="line">SocketChannel#configureBlocking</span><br><span class="line">ServerSocketChannel#configureBlocking</span><br><span class="line"></span><br><span class="line">selector</span><br></pre></td></tr></table></figure></li>
<li><p>TThreadSelectorServer [主从版的Reactor模式的实现][实战中推荐]</p>
<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230303100834019.png" alt="image-20230303100834019"></p>
<ul>
<li><p>client</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestClient1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> TException &#123;</span><br><span class="line">        <span class="comment">//完成  与服务端 网络连接的连接</span></span><br><span class="line">        <span class="type">TTransport</span> <span class="variable">tTransport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TSocket</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>);</span><br><span class="line">        <span class="type">TFramedTransport</span> <span class="variable">tFramedTransport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TFramedTransport</span>(tTransport);</span><br><span class="line">        tTransport.open();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建协议</span></span><br><span class="line">        <span class="type">TCompactProtocol</span> <span class="variable">tCompactProtocol</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCompactProtocol</span>(tFramedTransport);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建代理  stub 存根 桩</span></span><br><span class="line">        UserService.<span class="type">Client</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>.Client(tCompactProtocol);</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.queryUserByNameAndPassword(<span class="string">&quot;xiaojr&quot;</span>, <span class="string">&quot;9090&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user = &quot;</span> + user);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServer1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> TTransportException &#123;</span><br><span class="line">        <span class="type">TNonblockingServerSocket</span> <span class="variable">tNonblockingServerSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TNonblockingServerSocket</span>(<span class="number">9000</span>);</span><br><span class="line"></span><br><span class="line">        TFramedTransport.<span class="type">Factory</span> <span class="variable">tFramedTransport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TFramedTransport</span>.Factory();</span><br><span class="line">        TCompactProtocol.<span class="type">Factory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TCompactProtocol</span>.Factory();</span><br><span class="line"></span><br><span class="line">        UserService.<span class="type">Processor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>.Processor(<span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>());</span><br><span class="line"></span><br><span class="line">        TThreadedSelectorServer.<span class="type">Args</span> <span class="variable">arg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TThreadedSelectorServer</span>.Args(tNonblockingServerSocket);</span><br><span class="line">        arg.transportFactory(tFramedTransport);</span><br><span class="line">        arg.protocolFactory(factory);</span><br><span class="line">        arg.processor(processor);</span><br><span class="line"></span><br><span class="line">        <span class="type">TServer</span> <span class="variable">tServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TThreadedSelectorServer</span>(arg);</span><br><span class="line">        tServer.serve();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>坑</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> client server thrift版本（maven） 一致</span><br><span class="line"><span class="bullet">2.</span> client server通信的transport protocal 保持一致</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="4-gRPC"><a href="#4-gRPC" class="headerlink" title="4. gRPC"></a>4. gRPC</h4><h5 id="4-1-gRPC简介"><a href="#4-1-gRPC简介" class="headerlink" title="4.1 gRPC简介"></a>4.1 gRPC简介</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> gRPC 是由google开源的一个高性能的RPC框架。Stubby Google内部的RPC,演化而来的，2015正式开源。云原生时代是一个RPC标准。</span><br><span class="line"><span class="bullet">2.</span> gRPC 核心的设计思路 </span><br><span class="line"><span class="bullet">         1.</span> 网络通信 ---&gt; gRPC自己封装网络通信的部分 提供多种语言的 网络通信的封装 （C Java[Netty] GO)</span><br><span class="line"><span class="bullet">         2.</span> 协议    ---&gt; HTTP2 传输数据的时候 二进制数据内容。 支持双向流（双工）连接的多路复用。</span><br><span class="line"><span class="bullet">         3.</span> 序列化   ---&gt; 基本文本 JSON  基于二进制 Java原生序列化方式 Thrift二进制的序列化 压缩二级制序列化。</span><br><span class="line"><span class="code">                         protobuf (Protocol Buffers) google开源一种序列化方式  时间效率和空间效率是JSON的3---5倍。</span></span><br><span class="line"><span class="code">                         IDL语言 </span></span><br><span class="line"><span class="code">         4. 代理的创建 ---&gt;让调用者像调用本地方法那样 去调用远端的服务方法。</span></span><br><span class="line"><span class="code">                          stub</span></span><br><span class="line"><span class="code">3. gRPC 与 ThriftRPC 区别</span></span><br><span class="line"><span class="code">   共性：支持异构语言的RPC。</span></span><br><span class="line"><span class="code">   区别：</span></span><br><span class="line"><span class="code">        1. 网络通信 Thrift TCP   专属协议</span></span><br><span class="line"><span class="code">                   GRPC   HTTP2</span></span><br><span class="line"><span class="code">        2. 性能角度 ThriftRPC 性能 高于 gRPC</span></span><br><span class="line"><span class="code">        3. gRPC 大厂背书（Google),云原生时代 与其他组件合作的顺利。所以gRPC应用更广泛。</span></span><br><span class="line"><span class="code">        </span></span><br><span class="line"><span class="code">4. gRPC的好处 </span></span><br><span class="line"><span class="code">   1. 高效的进行进程间通信。</span></span><br><span class="line"><span class="code">   2. 支持多种语言 原生支持 C  Go Java实现。C语言版本上扩展 C++ C# NodeJS Python Ruby PHP..</span></span><br><span class="line"><span class="code">   3. 支持多平台运行 Linux Android IOS MacOS Windows。</span></span><br><span class="line"><span class="code">   4. gPRC序列化方式采用protobuf，效率高。</span></span><br><span class="line"><span class="code">   5. 使用Http2协议</span></span><br><span class="line"><span class="code">   6. 大厂的背书</span></span><br></pre></td></tr></table></figure>

<h5 id="4-2-Http2-0协议"><a href="#4-2-Http2-0协议" class="headerlink" title="4.2 Http2.0协议"></a>4.2 Http2.0协议</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 回顾 Http1.x协议 </span><br><span class="line">   Http1.0协议  请求响应的模式 短连接协议（无状态协议）  传输数据文本结构     单工 无法实现服务端推送 变相实现推动（客户端轮训的方式） </span><br><span class="line">   Http1.1协议  请求响应的模式 有限的长连接            升级的方式WebSocket 双工 实现服务器向客户端推送。</span><br><span class="line">   总结Http1.x协议 共性</span><br><span class="line"><span class="bullet">     1.</span> 传输数据文本格式 可读性好的但是效率差。</span><br><span class="line"><span class="bullet">     2.</span> 本质上Http1.x协议无法实现双工通信。</span><br><span class="line"><span class="bullet">     3.</span> 资源的请求。需要发送多次请求，建立多个连接才可以完成。 </span><br><span class="line"><span class="bullet">2.</span> HTTP2.0协议 </span><br><span class="line"><span class="bullet">     1.</span> Http2.0协议是一个二进制协议，效率高于Http1.x协议，可读性差。</span><br><span class="line"><span class="bullet">     2.</span> 可以实现双工通信。</span><br><span class="line"><span class="bullet">     3.</span> 一个请求 一个连接 可以请求多个数据。【多路复用】</span><br><span class="line"><span class="bullet">3.</span> Http2.0协议的三个概念</span><br><span class="line"><span class="bullet">     1.</span> 数据流 stream</span><br><span class="line"><span class="bullet">     2.</span> 消息   message</span><br><span class="line"><span class="bullet">     3.</span> 帧    frame    参看图</span><br><span class="line"><span class="bullet">4.</span> 其他的相关概念</span><br><span class="line"><span class="bullet">     1.</span> 数据流的优先级，可以通过为不同的stream设置权重，来限制不同流的传输顺序。</span><br><span class="line"><span class="bullet">     2.</span> 流控 client发送的数据太快了，server处理不过来，通知client暂停数据的发送。</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20240421124819648.png" alt="image-20240421124819648"></p>
<h5 id="4-3-Protocol-Buffers-protobuf"><a href="#4-3-Protocol-Buffers-protobuf" class="headerlink" title="4.3 Protocol Buffers [protobuf]"></a>4.3 Protocol Buffers [protobuf]</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> protobuf 是一种与编程语言无关【IDL】,与具体的平台无关【OS】。他定义的中间语言，可以方便的在client 于 server中进行RPC的数据传输。</span><br><span class="line"><span class="bullet">2.</span> protobuf 两种版本 proto2 proto3,但是目前主流应用的都是proto3。</span><br><span class="line"><span class="bullet">3.</span> protobuf主要安装protobuf的编译器，编译器目的，可以把protobuf的IDL语言，转换成具体某一种开发语言。</span><br></pre></td></tr></table></figure>

<h6 id="4-3-1-protobuf编译器的安装"><a href="#4-3-1-protobuf编译器的安装" class="headerlink" title="4.3.1 protobuf编译器的安装"></a>4.3.1 protobuf编译器的安装</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/protocolbuffers/protobuf/releases</span><br><span class="line">windows 版本</span><br><span class="line"><span class="bullet">  1.</span> 直接解压缩 方式在一个特定的目录下面</span><br><span class="line"><span class="bullet">  2.</span> 直接配置环境变量 path</span><br><span class="line"><span class="code">     protoc --version</span></span><br><span class="line"><span class="code">mac    版本</span></span><br><span class="line"><span class="code">  brew install protobuf </span></span><br><span class="line"><span class="code">     protoc --version</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230305205216711.png" alt="image-20230305205216711"></p>
<h6 id="4-3-2-protobuf-IDEA的插件"><a href="#4-3-2-protobuf-IDEA的插件" class="headerlink" title="4.3.2 protobuf IDEA的插件"></a>4.3.2 protobuf IDEA的插件</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 2021.2版本后面的新版本 IDEA内置了Protobuf插件</span><br><span class="line"><span class="bullet">2.</span> 之前版本 可以选装第三方Protobuf插件</span><br><span class="line"><span class="bullet">3.</span> 二者不能共存。</span><br></pre></td></tr></table></figure>

<h6 id="4-3-3protobuf的语法详解"><a href="#4-3-3protobuf的语法详解" class="headerlink" title="4.3.3protobuf的语法详解"></a><strong>4.3.3protobuf的语法详解</strong></h6><ul>
<li><p>文件格式</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.proto</span><br><span class="line"></span><br><span class="line">UserService.proto</span><br><span class="line">OrderService.proto</span><br></pre></td></tr></table></figure></li>
<li><p>版本设定</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br></pre></td></tr></table></figure></li>
<li><p>注释</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 单行注释   //</span><br><span class="line"><span class="bullet">2.</span> 多行注释   /<span class="emphasis">*    *</span>/</span><br></pre></td></tr></table></figure></li>
<li><p>与Java语言相关的语法</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#后续protobuf生成的java代码 一个源文件还是多个源文件  xx.java</span></span><br><span class="line">option java<span class="emphasis">_multiple_</span>files = false; </span><br><span class="line"></span><br><span class="line"><span class="section">#指定protobuf生成的类 放置在哪个包中</span></span><br><span class="line">option java<span class="emphasis">_package = &quot;com.suns&quot;;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">#指定的protobuf生成的外部类的名字（管理内部类【内部类才是真正开发使用】）</span></span><br><span class="line"><span class="emphasis">option java_</span>outer<span class="emphasis">_classname = &quot;UserServce&quot;;</span></span><br><span class="line"><span class="emphasis"></span></span><br></pre></td></tr></table></figure></li>
<li><p>逻辑包【了解】</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 对于protobuf对于文件内容的管理</span></span><br><span class="line">package xxx;</span><br></pre></td></tr></table></figure></li>
<li><p>导入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UserService.proto</span><br><span class="line"></span><br><span class="line">OrderService.proto</span><br><span class="line">  import &quot;xxx/UserService.proto&quot;;</span><br></pre></td></tr></table></figure></li>
<li><p>基本类型</p>
<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230307104440839.png" alt="image-20230307104440839"></p>
</li>
<li><p>枚举</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum </span><span class="title class_">SEASON</span>&#123;</span><br><span class="line">   SPRING = <span class="number">0</span>;</span><br><span class="line">   SUMMER = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">枚举的值 必须是<span class="number">0</span>开始 </span><br></pre></td></tr></table></figure></li>
<li><p>消息 Message </p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">LoginRequest</span> &#123;</span><br><span class="line">   <span class="type">string</span> username = <span class="number">1</span>;</span><br><span class="line">   singular <span class="type">string</span> password = <span class="number">2</span>;</span><br><span class="line">   <span class="type">int32</span>  age = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">编号 从<span class="number">1</span>开始 到<span class="number">2</span>^<span class="number">29</span>-<span class="number">1</span>  注意：<span class="number">19000</span> - <span class="number">19999</span> 不能用这个区间内的编号，因为他是protobuf自己保留的。</span><br><span class="line"></span><br><span class="line">- singular : 这个字段的值 只能是<span class="number">0</span>个或<span class="number">1</span>个 （默认关键字）  null   <span class="string">&quot;123456&quot;</span></span><br><span class="line">- <span class="keyword">repeated</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Result</span>&#123;</span><br><span class="line">   <span class="type">string</span> content = <span class="number">1</span>;</span><br><span class="line">   <span class="keyword">repeated</span> <span class="type">string</span> stutas = <span class="number">2</span>; <span class="comment">//这个字段 返回值 是多个 等价于 Java List Protobuf getStatusList()--&gt;List</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protobuf [grpc]</span><br><span class="line">可以定义多个消息 </span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">LoginRequest</span>&#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">LoginResponse</span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">消息可以嵌套 </span><br><span class="line"><span class="keyword">message </span><span class="title class_">SearchResponse</span>&#123;</span><br><span class="line">   <span class="keyword">message </span><span class="title class_">Result</span>&#123;</span><br><span class="line">      <span class="type">string</span> url = <span class="number">1</span>;</span><br><span class="line">      <span class="type">string</span> title = <span class="number">2</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">string</span> xxx = <span class="number">1</span>;</span><br><span class="line">  <span class="type">int32</span>  yyy = <span class="number">2</span>;</span><br><span class="line">  Result ppp = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SearchResponse.Result</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">AAA</span>&#123;</span><br><span class="line">  <span class="type">string</span> xxx = <span class="number">1</span>;</span><br><span class="line">  SearchResponse.Result yyy = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">oneof</span> [其中一个]</span><br><span class="line"><span class="keyword">message </span><span class="title class_">SimpleMessage</span>&#123;</span><br><span class="line">   <span class="keyword">oneof</span> test_oneof&#123;</span><br><span class="line">      <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">      <span class="type">int32</span>  age = <span class="number">2</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   test_oneof xxx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>服务</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">HelloService</span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">rpc</span> hello(HelloRequest) <span class="keyword">returns</span>(HelloResponse)</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"># 里面是可以定义多个服务方法。</span><br><span class="line"># 定义多个服务接口</span><br><span class="line"># gPRC 服务 <span class="number">4</span>个服务方式 。</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="4-3-4-第一个gPRC的开发"><a href="#4-3-4-第一个gPRC的开发" class="headerlink" title="4.3.4 第一个gPRC的开发"></a>4.3.4 第一个gPRC的开发</h6><ul>
<li><p>项目结构</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> xxxx-api 模块 </span><br><span class="line">   定义 protobuf idl语言 </span><br><span class="line">   并且通过命令创建对应的代码</span><br><span class="line"><span class="bullet">   2.</span> service </span><br><span class="line"><span class="bullet">2.</span> xxxx-server模块</span><br><span class="line"><span class="bullet">   1.</span> 实现api模块中定义的服务接口</span><br><span class="line"><span class="bullet">   2.</span> 发布gRPC服务 (创建服务端程序)</span><br><span class="line"><span class="bullet">3.</span> xxxx-clien模块</span><br><span class="line"><span class="bullet">   1.</span> 创建服务端stub(代理)</span><br><span class="line"><span class="bullet">   2.</span> 基于代理（stub) RPC调用。</span><br></pre></td></tr></table></figure></li>
<li><p>api模块</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> .proto文件 书写protobuf的IDL</span><br><span class="line"><span class="bullet">2.</span> [了解]protoc命令 把proto文件中的IDL 转换成编程语言 </span><br><span class="line">   protoc --java<span class="emphasis">_out=/xxx/xxx  /xxx/xxx/xx.proto</span></span><br><span class="line"><span class="emphasis">3. [实战] maven插件 进行protobuf IDL文件的编译，并把他放置IDEA具体位置。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">pom.xml</span><br><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- necessary for Java 9+ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>annotations-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:3.21.7:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:1.52.1:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230308132952661.png" alt="image-20230308132952661"></p>
</li>
<li><p>xxxx-server 服务端模块的开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 实现业务接口 添加具体的功能 （MyBatis+MySQL)</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">HelloServiceGrpc</span>.HelloServiceImplBase &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      1. 接受client提交的参数  request.getParameter()</span></span><br><span class="line"><span class="comment">      2. 业务处理 service+dao 调用对应的业务功能。</span></span><br><span class="line"><span class="comment">      3. 提供返回值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(HelloProto.HelloRequest request, StreamObserver&lt;HelloProto.HelloResponse&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="comment">//1.接受client的请求参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> request.getName();</span><br><span class="line">        <span class="comment">//2.业务处理</span></span><br><span class="line">        System.out.println(<span class="string">&quot;name parameter &quot;</span>+name);</span><br><span class="line">        <span class="comment">//3.封装响应</span></span><br><span class="line">        <span class="comment">//3.1 创建相应对象的构造者</span></span><br><span class="line">        HelloProto.HelloResponse.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> HelloProto.HelloResponse.newBuilder();</span><br><span class="line">        <span class="comment">//3.2 填充数据</span></span><br><span class="line">        builder.setResult(<span class="string">&quot;hello method invoke ok&quot;</span>);</span><br><span class="line">        <span class="comment">//3.3 封装响应</span></span><br><span class="line">        HelloProto.<span class="type">HelloResponse</span> <span class="variable">helloResponse</span> <span class="operator">=</span> builder.build();</span><br><span class="line"></span><br><span class="line">        responseObserver.onNext(helloResponse);</span><br><span class="line">        responseObserver.onCompleted();;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2.</span> 创建服务端 （Netty)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GprcServer1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">//1. 绑定端口 </span></span><br><span class="line">        <span class="type">ServerBuilder</span> <span class="variable">serverBuilder</span> <span class="operator">=</span> ServerBuilder.forPort(<span class="number">9000</span>);</span><br><span class="line">        <span class="comment">//2. 发布服务</span></span><br><span class="line">        serverBuilder.addService(<span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>());</span><br><span class="line">        <span class="comment">//serverBuilder.addService(new UserServiceImpl());</span></span><br><span class="line">        <span class="comment">//3. 创建服务对象</span></span><br><span class="line">        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> serverBuilder.build();</span><br><span class="line">        </span><br><span class="line">        server.start();</span><br><span class="line">        server.awaitTermination();;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>xxx-client 模块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> client通过代理对象完成远端对象的调用</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GprcClient1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1 创建通信的管道</span></span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>).usePlaintext().build();</span><br><span class="line">        <span class="comment">//2 获得代理对象 stub</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HelloServiceGrpc.<span class="type">HelloServiceBlockingStub</span> <span class="variable">helloService</span> <span class="operator">=</span> HelloServiceGrpc.newBlockingStub(managedChannel);</span><br><span class="line">            <span class="comment">//3. 完成RPC调用</span></span><br><span class="line">            <span class="comment">//3.1 准备参数</span></span><br><span class="line">            HelloProto.HelloRequest.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> HelloProto.HelloRequest.newBuilder();</span><br><span class="line">            builder.setName(<span class="string">&quot;sunshuai&quot;</span>);</span><br><span class="line">            HelloProto.<span class="type">HelloRequest</span> <span class="variable">helloRequest</span> <span class="operator">=</span> builder.build();</span><br><span class="line">            <span class="comment">//3.1 进行功能rpc调用，获取相应的内容</span></span><br><span class="line">            HelloProto.<span class="type">HelloResponse</span> <span class="variable">helloResponse</span> <span class="operator">=</span> helloService.hello(helloRequest);</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> helloResponse.getResult();</span><br><span class="line">            System.out.println(<span class="string">&quot;result = &quot;</span> + result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            managedChannel.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>注意事项</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">服务端 处理返回值时</span><br><span class="line">responseObserver.onNext(helloResponse1);  //通过这个方法 把响应的消息 回传client</span><br><span class="line">responseObserver.onCompleted();           //通知client 整个服务结束。底层返回标记 </span><br><span class="line"><span class="code">                                          // client就会监听标记 【grpc做的】</span></span><br><span class="line"><span class="code">                                          </span></span><br><span class="line"><span class="code">requestObserver.onNext(helloRequest1);</span></span><br><span class="line"><span class="code">requestObserver.onCompleted();</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="4-3-5gRpc的四种通信方式"><a href="#4-3-5gRpc的四种通信方式" class="headerlink" title="4.3.5gRpc的四种通信方式"></a>4.3.5gRpc的四种通信方式</h6><ul>
<li><p>四种通信方式</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 简单rpc 一元rpc (Unary RPC)</span><br><span class="line"><span class="bullet">2.</span> 服务端流式RPC   (Server Streaming RPC)</span><br><span class="line"><span class="bullet">3.</span> 客户端流式RPC   (Client Streaming RPC)</span><br><span class="line"><span class="bullet">4.</span> 双向流RPC (Bi-directional Stream RPC)</span><br></pre></td></tr></table></figure></li>
<li><p>简单RPC(一元RPC)</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 第一个RPC程序，实际上就是一元RPC</span><br></pre></td></tr></table></figure>

<ul>
<li><p>特点</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">当client发起调用后，提交数据，并且等待 服务端响应。</span><br><span class="line">开发过程中，主要采用就是一元RPC的这种通信方式</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230309153848531.png" alt="image-20230309153848531"></p>
</li>
<li><p>语法</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service </span><span class="title class_">HelloService</span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> hello(HelloRequest) <span class="keyword">returns</span> (HelloResponse)</span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> hello1(HelloRequest1) <span class="keyword">returns</span> (HelloResponse1)</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>服务端流式RPC </p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个请求对象，服务端可以回传多个结果对象。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>特点</p>
<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230309154817840.png" alt="image-20230309154817840"></p>
</li>
<li><p>使用场景</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client  --------&gt; Server</span><br><span class="line"><span class="code">        股票标号</span></span><br><span class="line"><span class="code">        &lt;-------</span></span><br><span class="line"><span class="code">         某一个时刻的 股票的行情</span></span><br></pre></td></tr></table></figure></li>
<li><p>语法</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service HelloService&#123;</span><br><span class="line">  rpc hello(HelloRequest) returns (stream HelloResponse)&#123;&#125;</span><br><span class="line">  rpc hello1(HelloRequest1) returns (HelloResponse1)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>关键代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">服务端</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">c2ss</span><span class="params">(HelloProto.HelloRequest request, StreamObserver&lt;HelloProto.HelloResponse&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="comment">//1 接受client的请求参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> request.getName();</span><br><span class="line">        <span class="comment">//2 做业务处理</span></span><br><span class="line">        System.out.println(<span class="string">&quot;name = &quot;</span> + name);</span><br><span class="line">        <span class="comment">//3 根据业务处理的结果，提供响应</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">            HelloProto.HelloResponse.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> HelloProto.HelloResponse.newBuilder();</span><br><span class="line">            builder.setResult(<span class="string">&quot;处理的结果 &quot;</span> + i);</span><br><span class="line">            HelloProto.<span class="type">HelloResponse</span> <span class="variable">helloResponse</span> <span class="operator">=</span> builder.build();</span><br><span class="line"></span><br><span class="line">            responseObserver.onNext(helloResponse);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">客户端</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GprcClient3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>).usePlaintext().build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HelloServiceGrpc.<span class="type">HelloServiceBlockingStub</span> <span class="variable">helloService</span> <span class="operator">=</span> HelloServiceGrpc.newBlockingStub(managedChannel);</span><br><span class="line"></span><br><span class="line">            HelloProto.HelloRequest.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> HelloProto.HelloRequest.newBuilder();</span><br><span class="line">            builder.setName(<span class="string">&quot;sunshuai&quot;</span>);</span><br><span class="line">            HelloProto.<span class="type">HelloRequest</span> <span class="variable">helloRequest</span> <span class="operator">=</span> builder.build();</span><br><span class="line">            Iterator&lt;HelloProto.HelloResponse&gt; helloResponseIterator = helloService.c2ss(helloRequest);</span><br><span class="line">            <span class="keyword">while</span> (helloResponseIterator.hasNext()) &#123;</span><br><span class="line">                HelloProto.<span class="type">HelloResponse</span> <span class="variable">helloResponse</span> <span class="operator">=</span> helloResponseIterator.next();</span><br><span class="line">                System.out.println(<span class="string">&quot;helloResponse.getResult() = &quot;</span> + helloResponse.getResult());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            managedChannel.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">监听 异步方式 处理服务端流式RPC的开发</span><br><span class="line"><span class="number">1.</span> api</span><br><span class="line"><span class="number">2.</span> 服务端 </span><br><span class="line"><span class="number">3.</span> 客户端 </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcClient4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>).usePlaintext().build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            HelloServiceGrpc.<span class="type">HelloServiceStub</span> <span class="variable">helloService</span> <span class="operator">=</span> HelloServiceGrpc.newStub(managedChannel);</span><br><span class="line"></span><br><span class="line">            HelloProto.HelloRequest.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> HelloProto.HelloRequest.newBuilder();</span><br><span class="line">            builder.setName(<span class="string">&quot;xiaohei&quot;</span>);</span><br><span class="line">            HelloProto.<span class="type">HelloRequest</span> <span class="variable">helloRequest</span> <span class="operator">=</span> builder.build();</span><br><span class="line"></span><br><span class="line">            helloService.c2ss(helloRequest, <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;HelloProto.HelloResponse&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(HelloProto.HelloResponse value)</span> &#123;</span><br><span class="line">                    <span class="comment">//服务端 响应了 一个消息后，需要立即处理的话。把代码写在这个方法中。</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;服务端每一次响应的信息 &quot;</span> + value.getResult());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">//需要把服务端 响应的所有数据 拿到后，在进行业务处理。</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;服务端响应结束 后续可以根据需要 在这里统一处理服务端响应的所有内容&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            managedChannel.awaitTermination(<span class="number">12</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            managedChannel.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>客户端流式RPC</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端发送多个请求对象，服务端只返回一个结果</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230310142153479.png" alt="image-20230310142153479"></p>
<ul>
<li><p>应用场景</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IOT(物联网 【传感器】) 向服务端 发送数据</span><br></pre></td></tr></table></figure></li>
<li><p>proto</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">rpc</span> cs2s(stream HelloRequest) <span class="keyword">returns</span> (HelloResponse)</span>&#123;&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> api</span><br><span class="line">   rpc <span class="title function_">cs2s</span><span class="params">(stream HelloRequest)</span> returns (HelloResponse)&#123;&#125;</span><br><span class="line"><span class="number">2.</span> 服务端开发</span><br><span class="line">   <span class="keyword">public</span> StreamObserver&lt;HelloProto.HelloRequest&gt; cs2s(StreamObserver&lt;HelloProto.HelloResponse&gt; responseObserver) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;HelloProto.HelloRequest&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(HelloProto.HelloRequest value)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接受到了client发送一条消息 &quot;</span> + value.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;client的所有消息 都发送到了 服务端 ....&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//提供响应：响应的目的：当接受了全部client提交的信息，并处理后，提供相应</span></span><br><span class="line">                HelloProto.HelloResponse.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> HelloProto.HelloResponse.newBuilder();</span><br><span class="line">                builder.setResult(<span class="string">&quot;this is result&quot;</span>);</span><br><span class="line">                HelloProto.<span class="type">HelloResponse</span> <span class="variable">helloResponse</span> <span class="operator">=</span> builder.build();</span><br><span class="line"></span><br><span class="line">                responseObserver.onNext(helloResponse);</span><br><span class="line">                responseObserver.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">3.</span> 客户端开发</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcClient5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>).usePlaintext().build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HelloServiceGrpc.<span class="type">HelloServiceStub</span> <span class="variable">helloService</span> <span class="operator">=</span> HelloServiceGrpc.newStub(managedChannel);</span><br><span class="line"></span><br><span class="line">            StreamObserver&lt;HelloProto.HelloRequest&gt; helloRequestStreamObserver = helloService.cs2s(<span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;HelloProto.HelloResponse&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(HelloProto.HelloResponse value)</span> &#123;</span><br><span class="line">                    <span class="comment">// 监控响应</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;服务端 响应 数据内容为 &quot;</span> + value.getResult());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;服务端响应结束 ... &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//客户端 发送数据 到服务端  多条数据 ，不定时...</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                HelloProto.HelloRequest.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> HelloProto.HelloRequest.newBuilder();</span><br><span class="line">                builder.setName(<span class="string">&quot;sunshuai &quot;</span> + i);</span><br><span class="line">                HelloProto.<span class="type">HelloRequest</span> <span class="variable">helloRequest</span> <span class="operator">=</span> builder.build();</span><br><span class="line"></span><br><span class="line">                helloRequestStreamObserver.onNext(helloRequest);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            helloRequestStreamObserver.onCompleted();</span><br><span class="line"></span><br><span class="line">            managedChannel.awaitTermination(<span class="number">12</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            managedChannel.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>双向流式RPC</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">客户端可以发送多个请求消息，服务端响应多个响应消息</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230310151339486.png" alt="image-20230310151339486"></p>
<ul>
<li><p>应用场景</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">聊天室</span><br></pre></td></tr></table></figure></li>
<li><p>编码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> api</span><br><span class="line">    rpc <span class="title function_">cs2ss</span><span class="params">(stream HelloRequest)</span> returns (stream HelloResponse)&#123;&#125;</span><br><span class="line"><span class="number">2.</span> 服务端</span><br><span class="line">    <span class="keyword">public</span> StreamObserver&lt;HelloProto.HelloRequest&gt; cs2ss(StreamObserver&lt;HelloProto.HelloResponse&gt; responseObserver) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;HelloProto.HelloRequest&gt;() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(HelloProto.HelloRequest value)</span> &#123;</span><br><span class="line">                 System.out.println(<span class="string">&quot;接受到client 提交的消息 &quot;</span>+value.getName());</span><br><span class="line">                 responseObserver.onNext(HelloProto.HelloResponse.newBuilder().setResult(<span class="string">&quot;response &quot;</span>+value.getName()+<span class="string">&quot; result &quot;</span>).build());</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                 System.out.println(<span class="string">&quot;接受到了所有的请求消息 ... &quot;</span>);</span><br><span class="line">                 responseObserver.onCompleted();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">3.</span> 客户端</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcClient6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>).usePlaintext().build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HelloServiceGrpc.<span class="type">HelloServiceStub</span> <span class="variable">helloService</span> <span class="operator">=</span> HelloServiceGrpc.newStub(managedChannel);</span><br><span class="line"></span><br><span class="line">            StreamObserver&lt;HelloProto.HelloRequest&gt; helloRequestStreamObserver = helloService.cs2ss(<span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;HelloProto.HelloResponse&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(HelloProto.HelloResponse value)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;响应的结果 &quot;</span>+value.getResult());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;响应全部结束...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                helloRequestStreamObserver.onNext(HelloProto.HelloRequest.newBuilder().setName(<span class="string">&quot;sunshuai &quot;</span> + i).build());</span><br><span class="line">            &#125;</span><br><span class="line">            helloRequestStreamObserver.onCompleted();</span><br><span class="line"></span><br><span class="line">            managedChannel.awaitTermination(<span class="number">12</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            managedChannel.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h6 id="4-3-6-gPRC代理方式"><a href="#4-3-6-gPRC代理方式" class="headerlink" title="4.3.6 gPRC代理方式"></a>4.3.6 gPRC代理方式</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> BlockingStub</span><br><span class="line">   阻塞 通信方式 </span><br><span class="line"><span class="bullet">2.</span> Stub</span><br><span class="line">   异步 通过监听处理的</span><br><span class="line"><span class="bullet">3.</span> FutureStub</span><br><span class="line">   同步 异步 NettyFuture</span><br><span class="line"><span class="bullet">   1.</span> FutureStub只能应用 一元RPC </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcClient7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>).usePlaintext().build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TestServiceGrpc.<span class="type">TestServiceFutureStub</span> <span class="variable">testServiceFutureStub</span> <span class="operator">=</span> TestServiceGrpc.newFutureStub(managedChannel);</span><br><span class="line">            ListenableFuture&lt;TestProto.TestResponse&gt; responseListenableFuture = testServiceFutureStub.testSuns(TestProto.TestRequest.newBuilder().setName(<span class="string">&quot;xiaojren&quot;</span>).build());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 同步操作</span></span><br><span class="line"><span class="comment">            TestProto.TestResponse testResponse = responseListenableFuture.get();</span></span><br><span class="line"><span class="comment">            System.out.println(testResponse.getResult());*/</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">/*  responseListenableFuture.addListener(() -&gt; &#123;</span></span><br><span class="line"><span class="comment">                System.out.println(&quot;异步的rpc响应 回来了....&quot;);</span></span><br><span class="line"><span class="comment">            &#125;, Executors.newCachedThreadPool());*/</span></span><br><span class="line"></span><br><span class="line">            Futures.addCallback(responseListenableFuture, <span class="keyword">new</span> <span class="title class_">FutureCallback</span>&lt;TestProto.TestResponse&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(TestProto.TestResponse result)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;result.getResult() = &quot;</span> + result.getResult());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, Executors.newCachedThreadPool());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;后续的操作....&quot;</span>);</span><br><span class="line"></span><br><span class="line">            managedChannel.awaitTermination(<span class="number">12</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            managedChannel.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-gPRC与SpringBoot整合"><a href="#5-gPRC与SpringBoot整合" class="headerlink" title="5. gPRC与SpringBoot整合"></a>5. gPRC与SpringBoot整合</h4><h5 id="5-1-gRPC和SpringBoot整合的思想"><a href="#5-1-gRPC和SpringBoot整合的思想" class="headerlink" title="5.1 gRPC和SpringBoot整合的思想"></a>5.1 gRPC和SpringBoot整合的思想</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> grpc-server</span><br><span class="line"><span class="bullet">2.</span> grpc-client </span><br></pre></td></tr></table></figure>

<h6 id="SpringBoot与GRPC整合的过程中-对于服务端做了什么封装"><a href="#SpringBoot与GRPC整合的过程中-对于服务端做了什么封装" class="headerlink" title="SpringBoot与GRPC整合的过程中 对于服务端做了什么封装"></a>SpringBoot与GRPC整合的过程中 对于服务端做了什么封装</h6><p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20240421125030362.png" alt="image-20240421125030362"></p>
<ul>
<li><p>搭建开发环境</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 搭建SpringBoot的开发环境</span><br><span class="line">   </span><br><span class="line"><span class="bullet">2.</span> 引入与Grpc相关的内容</span><br><span class="line"><span class="code">    &lt;dependency&gt;</span></span><br><span class="line"><span class="code">          &lt;groupId&gt;com.suns&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">          &lt;artifactId&gt;rpc-grpc-api&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">          &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span></span><br><span class="line"><span class="code">     &lt;/dependency&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    &lt;dependency&gt;</span></span><br><span class="line"><span class="code">        &lt;groupId&gt;net.devh&lt;/groupId&gt;</span></span><br><span class="line"><span class="code">        &lt;artifactId&gt;grpc-server-spring-boot-starter&lt;/artifactId&gt;</span></span><br><span class="line"><span class="code">        &lt;version&gt;2.14.0.RELEASE&lt;/version&gt;</span></span><br><span class="line"><span class="code">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure></li>
<li><p>开发服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重复 多次 </span></span><br><span class="line"><span class="meta">@GrpcService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">HelloServiceGrpc</span>.HelloServiceImplBase &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(HelloProto.HelloRequest request, StreamObserver&lt;HelloProto.HelloResponse&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> request.getName();</span><br><span class="line">        System.out.println(<span class="string">&quot;name is &quot;</span> + name);</span><br><span class="line"></span><br><span class="line">        responseObserver.onNext(HelloProto.HelloResponse.newBuilder().setResult(<span class="string">&quot;this is result&quot;</span>).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// application.yml</span></span><br><span class="line"># 核心配置的 就是gRPC服务的端口号</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: boot-server</span><br><span class="line"></span><br><span class="line">  main:</span><br><span class="line">    web-application-type: none</span><br><span class="line"></span><br><span class="line">grpc:</span><br><span class="line">  server:</span><br><span class="line">    port: <span class="number">9000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>客户端</p>
<p>环境搭建</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span></span>net.devh<span class="language-xml"><span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span></span>grpc-client-spring-boot-starter<span class="language-xml"><span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span></span>2.14.0.RELEASE<span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>编码</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> yml</span><br><span class="line">grpc:</span><br><span class="line">  client:</span><br><span class="line"><span class="code">    grpc-server:</span></span><br><span class="line"><span class="code">      address: &#x27;static://127.0.0.1:9000&#x27;</span></span><br><span class="line"><span class="code">      negotiation-type: plaintext</span></span><br><span class="line"><span class="code">      </span></span><br><span class="line"><span class="code">2. 注入stub</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">@GrpcClient(&quot;grpc-server&quot;)</span><br><span class="line">private HelloServiceGrpc.HelloServiceBlockingStub stub;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-gPRC的高级应用"><a href="#6-gPRC的高级应用" class="headerlink" title="6. gPRC的高级应用"></a>6. gPRC的高级应用</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 拦截器  一元拦截器 </span><br><span class="line"><span class="bullet">2.</span> Stream Tracer [监听流]  流拦截器 </span><br><span class="line"><span class="bullet">3.</span> Retry Policy 客户端重试 </span><br><span class="line"><span class="bullet">4.</span> NameResolver </span><br><span class="line"><span class="bullet">5.</span> 负载均衡 （pick-first , 轮训）</span><br><span class="line"><span class="bullet">6.</span> grpc与微服务的整合 </span><br><span class="line">   序列化 （protobuf) Dobbo</span><br><span class="line">   grpc              Dobbo</span><br><span class="line">   grpc              GateWay</span><br><span class="line">   grpc              JWT</span><br><span class="line">   grpc              Nacos2.0</span><br><span class="line">   grpc              OpenFeign </span><br></pre></td></tr></table></figure>

<h5 id="6-1-拦截器"><a href="#6-1-拦截器" class="headerlink" title="6.1 拦截器"></a>6.1 拦截器</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 拦截器的作用</span><br><span class="line">   鉴权 ，数据校验 ，限流...</span><br><span class="line"><span class="bullet">2.</span> 常见的拦截器 </span><br><span class="line">   web        Filter</span><br><span class="line">   springmvc  Interceptor </span><br><span class="line">   SS         Filter</span><br><span class="line">   Netty      handler</span><br><span class="line"><span class="bullet">3.</span> gRPC的拦截器 </span><br><span class="line"><span class="bullet">   1.</span>  一元请求的 拦截器 </span><br><span class="line"><span class="code">       客户端 【请求 响应】</span></span><br><span class="line"><span class="code">       服务端 【请求 响应】</span></span><br><span class="line"><span class="code">   2.  流式请求的 拦截器  （Stream Tracer)</span></span><br><span class="line"><span class="code">       客户端 【请求 响应】</span></span><br><span class="line"><span class="code">       服务端 【请求 响应】</span></span><br></pre></td></tr></table></figure>

<h6 id="6-1-1-一元拦截器"><a href="#6-1-1-一元拦截器" class="headerlink" title="6.1.1 一元拦截器"></a>6.1.1 一元拦截器</h6><p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230316112142470.png" alt="image-20230316112142470"></p>
<ul>
<li><p>简单客户端拦截器的开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1 开发拦截器 </span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClientInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ClientInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; <span class="title function_">interceptCall</span><span class="params">(MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;这是一个拦截启动的处理 ,统一的做了一些操作 ....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> next.newCall(method, callOptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2 在客户端进行设置 </span></span><br><span class="line"> <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .intercept(<span class="keyword">new</span> <span class="title class_">CustomClientInterceptor</span>())</span><br><span class="line">                .build();</span><br><span class="line">细节：</span><br><span class="line">  usePlaintext()</span><br><span class="line">  intercept(）</span><br><span class="line">  调用的先后顺序没有必须关联，谁先谁后都行。</span><br></pre></td></tr></table></figure></li>
<li><p>简单客户端拦截器问题</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 只能拦截请求，不能拦截响应。</span><br><span class="line"><span class="bullet">2.</span> 即使拦截了请求操作，粒度业务过于宽泛，不精准。</span><br><span class="line"><span class="bullet">   1.</span> 开始阶段 2. 设置消息数量 3.发送数据阶段 4.半连接阶段。</span><br></pre></td></tr></table></figure></li>
<li><p>复杂客户端拦截器 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 拦截请求，拦截响应。</span><br><span class="line"><span class="number">2.</span> 分阶段的进行 请求 响应的拦截</span><br><span class="line"></span><br><span class="line">渗透的 ClientCall[方法]  装饰器设计模式 典型的使用场景。</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClientInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ClientInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; <span class="title function_">interceptCall</span><span class="params">(MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;这是一个拦截启动的处理 ,统一的做了一些操作 ....&quot;</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           如果我们需要用复杂客户端拦截器 ，就需要对原始的ClientCall进行包装</span></span><br><span class="line"><span class="comment">           那么这个时候，就不能反悔原始ClientCall对象，</span></span><br><span class="line"><span class="comment">           应该返回 包装的ClientCall ---&gt; CustomForwardingClientClass</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//return next.newCall(method, callOptions);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomForwardingClientClass</span>&lt;&gt;(next.newCall(method, callOptions));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   这个类型 适用于控制 拦截 请求发送各个环节</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomForwardingClientClass</span>&lt;ReqT, RespT&gt; <span class="keyword">extends</span> <span class="title class_">ClientInterceptors</span>.CheckedForwardingClientCall&lt;ReqT, RespT&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">CustomForwardingClientClass</span><span class="params">(ClientCall&lt;ReqT, RespT&gt; delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(delegate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//开始调用</span></span><br><span class="line">    <span class="comment">// 目的 看一个这个RPC请求是不是可以被发起。</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">checkedStart</span><span class="params">(Listener&lt;RespT&gt; responseListener, Metadata headers)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;发送请求数据之前的检查.....&quot;</span>);</span><br><span class="line">        <span class="comment">//真正的去发起grpc的请求</span></span><br><span class="line">        <span class="comment">// 是否真正发送grpc的请求，取决这个start方法的调用</span></span><br><span class="line">        <span class="comment">//delegate().start(responseListener, headers);</span></span><br><span class="line">        delegate().start(<span class="keyword">new</span> <span class="title class_">CustomCallListener</span>&lt;&gt;(responseListener), headers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//指定发送消息的数量</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">int</span> numMessages)</span> &#123;</span><br><span class="line">        <span class="comment">//添加一些功能</span></span><br><span class="line">        log.debug(<span class="string">&quot;request 方法被调用 ....&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.request(numMessages);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//发送消息 缓冲区</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(ReqT message)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;sendMessage 方法被调用... &#123;&#125; &quot;</span>, message);</span><br><span class="line">        <span class="built_in">super</span>.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//开启半连接 请求消息无法发送，但是可以接受响应的消息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">halfClose</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;halfClose 方法被调用... 开启了半连接&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.halfClose();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   用于监听响应，并对响应进行拦截</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomCallListener</span>&lt;RespT&gt; <span class="keyword">extends</span> <span class="title class_">ForwardingClientCallListener</span>.SimpleForwardingClientCallListener&lt;RespT&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">CustomCallListener</span><span class="params">(ClientCall.Listener&lt;RespT&gt; delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(delegate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onHeaders</span><span class="params">(Metadata headers)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;响应头信息 回来了......&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.onHeaders(headers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(RespT message)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;响应的数据 回来了.....&#123;&#125; &quot;</span>, message);</span><br><span class="line">        <span class="built_in">super</span>.onMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">onHeaders这个方法 会在onNext调用后 监听到数据</span><br><span class="line">onMessage这个方法 会在onCompleted调用后 监听到数据</span><br></pre></td></tr></table></figure></li>
<li><p>简单服务端拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomServerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ServerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; <span class="title function_">interceptCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; call, Metadata headers, ServerCallHandler&lt;ReqT, RespT&gt; next)</span> &#123;</span><br><span class="line">        <span class="comment">//在服务器端 拦截请求操作的功能 写在这个方法中</span></span><br><span class="line">        log.debug(<span class="string">&quot;服务器端拦截器生效.....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> next.startCall(call, headers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        ServerBuilder&lt;?&gt; serverBuilder = ServerBuilder.forPort(<span class="number">9000</span>);</span><br><span class="line">        serverBuilder.addService(<span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>());</span><br><span class="line">        serverBuilder.intercept(<span class="keyword">new</span> <span class="title class_">CustomServerInterceptor</span>());</span><br><span class="line">        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> serverBuilder.build();</span><br><span class="line"></span><br><span class="line">        server.start();</span><br><span class="line">        server.awaitTermination();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>简单服务端拦截器问题</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 拦截请求发送过来的数据，无法处理响应的数据</span><br><span class="line"><span class="bullet">2.</span> 拦截力度过于宽泛</span><br></pre></td></tr></table></figure></li>
<li><p>复杂服务端拦截器</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 拦截请求的数据，拦截响应的数据</span><br><span class="line"><span class="bullet">2.</span> 粒度细致</span><br></pre></td></tr></table></figure>

<ul>
<li><p>请求数据的拦截</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomServerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ServerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; <span class="title function_">interceptCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; call, Metadata headers, ServerCallHandler&lt;ReqT, RespT&gt; next)</span> &#123;</span><br><span class="line">        <span class="comment">//在服务器端 拦截请求操作的功能 写在这个方法中</span></span><br><span class="line">        log.debug(<span class="string">&quot;服务器端拦截器生效.....&quot;</span>);</span><br><span class="line">        <span class="comment">//默认返回的ServerCall.Listener仅仅能够完成请求数据的监听，单没有拦截功能</span></span><br><span class="line">        <span class="comment">//所以要做扩展，采用包装器设计模式。</span></span><br><span class="line">        <span class="comment">//return next.startCall(call, headers);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomServerCallListener</span>&lt;&gt;(next.startCall(call, headers));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomServerCallListener</span>&lt;ReqT&gt; <span class="keyword">extends</span> <span class="title class_">ForwardingServerCallListener</span>.SimpleForwardingServerCallListener&lt;ReqT&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">CustomServerCallListener</span><span class="params">(ServerCall.Listener&lt;ReqT&gt; delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(delegate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//准备接受请求数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReady</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;onRead Method Invoke....&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.onReady();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(ReqT message)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;接受到了 请求提交的数据  &#123;&#125; &quot;</span>, message);</span><br><span class="line">        <span class="built_in">super</span>.onMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onHalfClose</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;监听到了 半连接...&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.onHalfClose();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;服务端 onCompleted()...&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.onComplete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCancel</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;出现异常后 会调用这个方法... 关闭资源的操作&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.onCancel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>拦截响应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">目的：通过自定义的ServerCall 包装原始的ServerCall 增加对于响应拦截的功能</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomServerCall</span>&lt;ReqT, RespT&gt; <span class="keyword">extends</span> <span class="title class_">ForwardingServerCall</span>.SimpleForwardingServerCall&lt;ReqT, RespT&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">CustomServerCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(delegate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//指定发送消息的数量 【响应消息】</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">int</span> numMessages)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;response 指定消息的数量 【request】&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.request(numMessages);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//设置响应头</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendHeaders</span><span class="params">(Metadata headers)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;response 设置响应头 【sendHeaders】&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.sendHeaders(headers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//响应数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(RespT message)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;response 响应数据  【send Message 】 &#123;&#125; &quot;</span>, message);</span><br><span class="line">        <span class="built_in">super</span>.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//关闭连接</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">(Status status, Metadata trailers)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;respnse 关闭连接 【close】&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.close(status, trailers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">目的：就是把自定义的ServerCall与gRpc服务端进行整合</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomServerInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ServerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; <span class="title function_">interceptCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; call, Metadata headers, ServerCallHandler&lt;ReqT, RespT&gt; next)</span> &#123;</span><br><span class="line">        <span class="comment">//在服务器端 拦截请求操作的功能 写在这个方法中</span></span><br><span class="line">        log.debug(<span class="string">&quot;服务器端拦截器生效.....&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">//1. 包装ServerCall 处理服务端响应拦截</span></span><br><span class="line">        CustomServerCall&lt;ReqT,RespT&gt; reqTRespTCustomServerCall = <span class="keyword">new</span> <span class="title class_">CustomServerCall</span>&lt;&gt;(call);</span><br><span class="line">        <span class="comment">//2. 包装Listener   处理服务端请求拦截</span></span><br><span class="line">        CustomServerCallListener&lt;ReqT&gt; reqTCustomServerCallListener = <span class="keyword">new</span> <span class="title class_">CustomServerCallListener</span>&lt;&gt;(next.startCall(reqTRespTCustomServerCall, headers));</span><br><span class="line">        <span class="keyword">return</span> reqTCustomServerCallListener;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h6 id="6-1-2-流式拦截器"><a href="#6-1-2-流式拦截器" class="headerlink" title="6.1.2 流式拦截器"></a>6.1.2 流式拦截器</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">主要应用 gRPC除了 一元RPC之外的其他形式RPC操作的拦截工作</span><br><span class="line"><span class="bullet">1.</span> 服务端流式RPC</span><br><span class="line"><span class="bullet">2.</span> 客户端流式RPC</span><br><span class="line"><span class="bullet">3.</span> 双向流式RPC</span><br></pre></td></tr></table></figure>

<ul>
<li><p>一元通信方式 和 流式通信方式的区别</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">对比 一元通信方式，流式通信方式的特点是消息多，而且不是一次性通信，是分批分期。这个时候一元拦截器就无法细粒度的拦截特定的消息。</span><br><span class="line">所以需要流式拦截器 解决这个问题。流式拦截器【Stream Tracer】</span><br></pre></td></tr></table></figure></li>
<li><p>客户端流式拦截器的开发</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 拦截请求  拦截响应</span><br><span class="line"><span class="bullet">2.</span> 开发思路 </span><br><span class="line">   ClientStreamTracer [拦截请求 拦截响应]</span><br><span class="line">   ClientStreamTracerFactory </span><br><span class="line"><span class="code">      目的 就是用于创建ClientStreamTracer.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerClientInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ClientInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; <span class="title function_">interceptCall</span><span class="params">(MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;执行客户端拦截器...&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//把自己开发的ClientStreamTracerFactory融入到gRPC体系</span></span><br><span class="line">        callOptions = callOptions.withStreamTracerFactory(<span class="keyword">new</span> <span class="title class_">CustomClientStreamTracerFactory</span>&lt;&gt;());</span><br><span class="line">        <span class="keyword">return</span> next.newCall(method, callOptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomClientStreamTracerFactory</span>&lt;ReqT, RespT&gt; <span class="keyword">extends</span> <span class="title class_">ClientStreamTracer</span>.Factory &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ClientStreamTracer <span class="title function_">newClientStreamTracer</span><span class="params">(ClientStreamTracer.StreamInfo info, Metadata headers)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomClientStreamTracer</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 作用： 用于客户端流式拦截：拦截请求 拦截响应</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomClientStreamTracer</span>&lt;ReqT, RespT&gt; <span class="keyword">extends</span> <span class="title class_">ClientStreamTracer</span> &#123;</span><br><span class="line">    <span class="comment">//outbound 对于请求相关操作的拦截</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//用于输出响应头</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;client: 用于输出请求头.....&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.outboundHeaders();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//设置消息编号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundMessage</span><span class="params">(<span class="type">int</span> seqNo)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;client: 设置流消息的编号 &#123;&#125; &quot;</span>, seqNo);</span><br><span class="line">        <span class="built_in">super</span>.outboundMessage(seqNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundUncompressedSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;client: 获得未压缩消息的大小 &#123;&#125; &quot;</span>, bytes);</span><br><span class="line">        <span class="built_in">super</span>.outboundUncompressedSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//用于获得 输出消息的大小</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundWireSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;client: 用于获得 输出消息的大小 &#123;&#125; &quot;</span>, bytes);</span><br><span class="line">        <span class="built_in">super</span>.outboundWireSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//拦截消息发送</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundMessageSent</span><span class="params">(<span class="type">int</span> seqNo, <span class="type">long</span> optionalWireSize, <span class="type">long</span> optionalUncompressedSize)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;client: 监控请求操作 outboundMessageSent &#123;&#125; &quot;</span>, seqNo);</span><br><span class="line">        <span class="built_in">super</span>.outboundMessageSent(seqNo, optionalWireSize, optionalUncompressedSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//inbound  对于相应相关操作的拦截</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;用于获得响应头....&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.inboundHeaders();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundMessage</span><span class="params">(<span class="type">int</span> seqNo)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;获得响应消息的编号...&#123;&#125; &quot;</span>,seqNo);</span><br><span class="line">        <span class="built_in">super</span>.inboundMessage(seqNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundWireSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;获得响应消息的大小...&#123;&#125; &quot;</span>,bytes);</span><br><span class="line">        <span class="built_in">super</span>.inboundWireSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundMessageRead</span><span class="params">(<span class="type">int</span> seqNo, <span class="type">long</span> optionalWireSize, <span class="type">long</span> optionalUncompressedSize)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;集中获得消息的编号 ，大小 ，未压缩大小 &#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, seqNo, optionalWireSize, optionalUncompressedSize);</span><br><span class="line">        <span class="built_in">super</span>.inboundMessageRead(seqNo, optionalWireSize, optionalUncompressedSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundUncompressedSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;获得响应消息未压缩大小 &#123;&#125; &quot;</span>,bytes);</span><br><span class="line">        <span class="built_in">super</span>.inboundUncompressedSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundTrailers</span><span class="params">(Metadata trailers)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;响应结束..&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.inboundTrailers(trailers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>服务端流式拦截器的开发</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> ServerStreamTracer 拦截</span><br><span class="line">   inbound  请求的拦截</span><br><span class="line">   outbound 响应的拦截 </span><br><span class="line"><span class="bullet">2.</span> ServerStreamTracerFactory进行创建</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomServerStreamFactory</span> <span class="keyword">extends</span> <span class="title class_">ServerStreamTracer</span>.Factory &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServerStreamTracer <span class="title function_">newServerStreamTracer</span><span class="params">(String fullMethodName, Metadata headers)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomServerStreamTracer</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomServerStreamTracer</span> <span class="keyword">extends</span> <span class="title class_">ServerStreamTracer</span> &#123;</span><br><span class="line">    <span class="comment">//inbound 拦截请求</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundMessage</span><span class="params">(<span class="type">int</span> seqNo)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.inboundMessage(seqNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundWireSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.inboundWireSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundMessageRead</span><span class="params">(<span class="type">int</span> seqNo, <span class="type">long</span> optionalWireSize, <span class="type">long</span> optionalUncompressedSize)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;server: 获得client发送的请求消息 ...&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, seqNo, optionalWireSize, optionalUncompressedSize);</span><br><span class="line">        <span class="built_in">super</span>.inboundMessageRead(seqNo, optionalWireSize, optionalUncompressedSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inboundUncompressedSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.inboundUncompressedSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//outbound 拦截请求</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundMessage</span><span class="params">(<span class="type">int</span> seqNo)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.outboundMessage(seqNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundMessageSent</span><span class="params">(<span class="type">int</span> seqNo, <span class="type">long</span> optionalWireSize, <span class="type">long</span> optionalUncompressedSize)</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;server: 响应数据的拦截 ...&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, seqNo, optionalWireSize, optionalUncompressedSize);</span><br><span class="line">        <span class="built_in">super</span>.outboundMessageSent(seqNo, optionalWireSize, optionalUncompressedSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundWireSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.outboundWireSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">outboundUncompressedSize</span><span class="params">(<span class="type">long</span> bytes)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.outboundUncompressedSize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">serverBuilder.addStreamTracerFactory(<span class="keyword">new</span> <span class="title class_">CustomServerStreamFactory</span>());</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="6-2-客户端重试"><a href="#6-2-客户端重试" class="headerlink" title="6.2 客户端重试"></a>6.2 客户端重试</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">客户端重试保证了系统可靠性。</span><br><span class="line">在RGPC调用过程中看，因为网络延迟 或者抖动，可能操作客户端暂时链接不上服务端的情况，如果出现了此类情况的话。那么可以让client重试连接。尽可能的避免，因为网络问题，影响通信。从而保证了系统的可靠性。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 服务端 </span><br><span class="line">   模拟网络问题 </span><br><span class="line"><span class="number">2.</span> 客户端</span><br><span class="line">   &#123;</span><br><span class="line">  <span class="string">&quot;methodConfig&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;service&quot;</span>: <span class="string">&quot;com.suns.HelloService&quot;</span>, <span class="comment">//服务的名字 包名 package</span></span><br><span class="line">          <span class="string">&quot;method&quot;</span>: <span class="string">&quot;hello&quot;</span>  <span class="comment">//服务方法名字 </span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;retryPolicy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;maxAttempts&quot;</span>: <span class="number">3</span>,         <span class="comment">//重试的次数 </span></span><br><span class="line">        <span class="string">&quot;initialBackoff&quot;</span>: <span class="string">&quot;0.5s&quot;</span>, <span class="comment">//初始重试的延迟时间</span></span><br><span class="line">        <span class="string">&quot;maxBackof&quot;</span>: <span class="string">&quot;30s&quot;</span>,       <span class="comment">//最大重试的延迟时间</span></span><br><span class="line">        <span class="string">&quot;backoffMultiplier&quot;</span>: <span class="number">2</span>,   <span class="comment">//退避指数 每一次重试的时间间隔，不是不固定，2 4 6...</span></span><br><span class="line">        <span class="string">&quot;retryableStatusCodes&quot;</span>: [ <span class="comment">//只有当接受到了这个数组中描述的异常，才会发起重试</span></span><br><span class="line">          <span class="string">&quot;UNAVAILABLE&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">   <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">9000</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .defaultServiceConfig(serviceConfig) <span class="comment">//设置重试的参数 </span></span><br><span class="line">                .enableRetry()  <span class="comment">//打开重试 </span></span><br><span class="line">                .build();</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="6-3-命名解析-NameResovler"><a href="#6-3-命名解析-NameResovler" class="headerlink" title="6.3 命名解析 NameResovler"></a>6.3 命名解析 NameResovler</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 什么是命名解析</span><br><span class="line">   本质上就是我们在SOA或者微服务中，所说的注册中心。</span><br><span class="line"><span class="bullet">2.</span> 为什么需要注册中心(名字解析）？</span><br><span class="line">   rpc集群环境下，通过注册中心（名字解析）统一管理rpc集群 【负载均衡，监控检查....】</span><br><span class="line"><span class="bullet">3.</span> 目前开发中 常见注册中心 </span><br><span class="line">   Dubbo         zookeeper </span><br><span class="line">   SpringCloud   eureka nacos consul etcd ...  </span><br><span class="line"><span class="bullet">4.</span> gRPC 名字解析 注册中心 </span><br><span class="line"><span class="bullet">   1.</span> 默认gPRC是通过DNS 做注册中心。</span><br><span class="line"><span class="bullet">   2.</span> 可以用户自定义注册中心 （扩展）</span><br><span class="line"><span class="bullet">5.</span> 如何进行gRPC注册中心的扩展 【重点】</span><br><span class="line"><span class="code">              zk     etcd   consul </span></span><br><span class="line"><span class="code">   开发语言    java    go     go</span></span><br><span class="line"><span class="code">   算法       Paxos   Raft   Raft</span></span><br><span class="line"><span class="code">   多数据中心  不支持   不支持  支持 </span></span><br><span class="line"><span class="code">   web管理    支持     不支持  支持</span></span><br><span class="line"><span class="code">   ....</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zyzstart/picgodemo/img/image-20230319203204763.png" alt="image-20230319203204763"></p>
<h6 id="6-3-1-Consul"><a href="#6-3-1-Consul" class="headerlink" title="6.3.1 Consul"></a>6.3.1 Consul</h6><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> Consul是什么？</span><br><span class="line">   HashiCorp公司开源一个工具，用于实现分布式系统中服务发现（注册）与配置。nacos</span><br><span class="line">   https://www.consul.io/</span><br><span class="line">   一站式的解决方案，内置注册中心，健康检查，多数据中心，KeyValue存储。。。</span><br><span class="line"><span class="bullet">2.</span> Consul作用：</span><br><span class="line"><span class="bullet">   1.</span> 注册中心</span><br><span class="line"><span class="bullet">   2.</span> 配置中心 </span><br><span class="line"><span class="bullet">3.</span> 使用Consul的好处 </span><br><span class="line"><span class="bullet">   1.</span> 安装简单 ---》自带web管理界面 </span><br><span class="line"><span class="bullet">   2.</span> 使用方便 比如 健康检查</span><br><span class="line"><span class="bullet">   3.</span> 一致性算法 Raft..</span><br><span class="line"><span class="bullet">4.</span> Consul的安装</span><br><span class="line">   官网下载对应版本的内容，解压缩</span><br><span class="line">   终端【cmd】./consul agent -dev</span><br></pre></td></tr></table></figure>

<h6 id="6-3-2-Consul-Java客户端开发注册中心"><a href="#6-3-2-Consul-Java客户端开发注册中心" class="headerlink" title="6.3.2 Consul Java客户端开发注册中心"></a>6.3.2 Consul Java客户端开发注册中心</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 服务注册的本质：consul进行服务注册时，不关心服务的名字 服务的功能 做什么。ip+port </span><br><span class="line"><span class="number">2.</span> 一个gprc功能的集群 定义一个逻辑的名字 </span><br><span class="line"><span class="number">3.</span> consul会自己进行健康检查：本质 我们提供的这个服务的ip+port是不是可以通信。</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Consul Java客户端 进行注册中心服务端的开发 </span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="comment">//1 模拟服务  localhost:9000</span></span><br><span class="line">        <span class="type">ServerSocketChannel</span> <span class="variable">serverSocketChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">65535</span>);</span><br><span class="line">        serverSocketChannel.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 consul java client进行注册服务</span></span><br><span class="line">        <span class="comment">// 连接到consul服务器</span></span><br><span class="line">        <span class="type">Consul</span> <span class="variable">consulConnection</span> <span class="operator">=</span> Consul.builder().build();</span><br><span class="line">        <span class="comment">// 获得consul客户端对象</span></span><br><span class="line">        <span class="type">AgentClient</span> <span class="variable">agentClient</span> <span class="operator">=</span> consulConnection.agentClient();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> <span class="string">&quot;Server-&quot;</span> + UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 进行服务的注册</span></span><br><span class="line">        <span class="type">Registration</span> <span class="variable">service</span> <span class="operator">=</span> ImmutableRegistration.builder()</span><br><span class="line">                .name(<span class="string">&quot;grpc-server&quot;</span>)</span><br><span class="line">                .id(serviceId)</span><br><span class="line">                .address(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">                .port(port)</span><br><span class="line">                .tags(Collections.singletonList(<span class="string">&quot;server&quot;</span>))</span><br><span class="line">                .meta(Collections.singletonMap(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;1.0&quot;</span>))</span><br><span class="line">                <span class="comment">// ttl http tcp</span></span><br><span class="line">                <span class="comment">// 通过tpc的方式进行健康检查</span></span><br><span class="line">                .check(Registration.RegCheck.tcp(<span class="string">&quot;localhost:&quot;</span> + port, <span class="number">10</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        agentClient.register(service);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100</span> * <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">删除一个失效的服务</span><br><span class="line"> http:<span class="comment">//127.0.0.1:8500/v1/agent/service/deregister/Server-b37769f1-8422-4919-b3a7-c1235d1cdc22 </span></span><br><span class="line">健康检查</span><br><span class="line">  Registration.RegCheck.tcp(<span class="string">&quot;localhost:&quot;</span> + port, <span class="number">10</span>)</span><br><span class="line">  如果不做健康检查，那么consul是无法确定服务是否存活。</span><br><span class="line">  底层 开了新的线程 通过延迟队列的方式 与 对应的ip+port进行通信。</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Consul Java客户端 进行注册中心客户端的开发</span><br><span class="line">client根据集群的名字（服务的名字） 获得 一组健康的服务。根据负载均衡的算法，获取实际通信的rpc进行调用</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Consul</span> <span class="variable">consulConnection</span> <span class="operator">=</span> Consul.builder().build();</span><br><span class="line">        <span class="type">HealthClient</span> <span class="variable">healthClient</span> <span class="operator">=</span> consulConnection.healthClient();</span><br><span class="line">        ConsulResponse&lt;List&lt;ServiceHealth&gt;&gt; allServiceInstances = healthClient.getHealthyServiceInstances(<span class="string">&quot;grpc-server&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;ServiceHealth&gt; response = allServiceInstances.getResponse();</span><br><span class="line">        <span class="keyword">for</span> (ServiceHealth serviceHealth : response) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;serviceHealth.getService() = &quot;</span> + serviceHealth.getService());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 获取健康实例的时候，consul有可能同步不准确。</span><br><span class="line"><span class="number">2.</span> 由负载均衡决定 客户端访问那个服务。【客户端负载均衡】 </span><br></pre></td></tr></table></figure>

<h6 id="6-3-3-Grpc中Consul注册中心的开发"><a href="#6-3-3-Grpc中Consul注册中心的开发" class="headerlink" title="6.3.3 Grpc中Consul注册中心的开发"></a>6.3.3 Grpc中Consul注册中心的开发</h6><ul>
<li><p>服务端的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcServerConsul</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> random.nextInt(<span class="number">65535</span>);</span><br><span class="line"></span><br><span class="line">        ServerBuilder&lt;?&gt; serverBuilder = ServerBuilder.forPort(port);</span><br><span class="line">        serverBuilder.addService(<span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>());</span><br><span class="line">        <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> serverBuilder.build();</span><br><span class="line"></span><br><span class="line">        server.start();</span><br><span class="line">        log.debug(<span class="string">&quot;server is starting......&quot;</span>);</span><br><span class="line">        registerToConsul(<span class="string">&quot;127.0.0.1&quot;</span>, port);</span><br><span class="line">        server.awaitTermination();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerToConsul</span><span class="params">(String address, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">        <span class="type">Consul</span> <span class="variable">consul</span> <span class="operator">=</span> Consul.builder().build();</span><br><span class="line">        <span class="type">AgentClient</span> <span class="variable">client</span> <span class="operator">=</span> consul.agentClient();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> <span class="string">&quot;Server-&quot;</span> + UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        <span class="type">ImmutableRegistration</span> <span class="variable">service</span> <span class="operator">=</span> ImmutableRegistration.builder()</span><br><span class="line">                .id(serviceId)</span><br><span class="line">                .name(<span class="string">&quot;grpc-server&quot;</span>)</span><br><span class="line">                .address(address)</span><br><span class="line">                .port(port)</span><br><span class="line">                .tags(Collections.singletonList(<span class="string">&quot;server&quot;</span>))</span><br><span class="line">                .meta(Collections.singletonMap(<span class="string">&quot;version&quot;</span>, <span class="string">&quot;1.0&quot;</span>))</span><br><span class="line">                .check(Registration.RegCheck.tcp(address + <span class="string">&quot;:&quot;</span> + port, <span class="number">10</span>))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        client.register(service);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>客户端的处理</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 客户端在访问具体的grpc服务之前，到命名中心（注册中心 consul）去查找注册的服务。</span><br><span class="line">   命名解析 </span><br><span class="line"><span class="code">       NameResolver </span></span><br><span class="line"><span class="code">          根据名字（服务的名字） 去注册中心查找服务，进而进行访问</span></span><br><span class="line"><span class="code">       NameResolverProvider </span></span><br><span class="line"><span class="code">          作用：命名解析的提供者（工厂），用于创建命名解析对象，完成对于注册中心的访问。</span></span><br><span class="line"><span class="code">   内置的命名解析 </span></span><br><span class="line"><span class="code">       DNS方式处理的注册中心。修改自定义的名字解析的优先级，高于DNS才可以使用consul进行替换。</span></span><br><span class="line"><span class="code"> 2. 负载均衡   </span></span><br><span class="line"><span class="code">       grpc客户端内置 </span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 自定义NameResolver</span><br><span class="line"><span class="number">2.</span> 自定义NameResolverProvider</span><br></pre></td></tr></table></figure>

<ul>
<li><p>customNameResolver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomNameResolver</span> <span class="keyword">extends</span> <span class="title class_">NameResolver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledThreadPoolExecutor</span> <span class="variable">scheduledThreadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Consul consul;</span><br><span class="line">    <span class="keyword">private</span> String authority;</span><br><span class="line">    <span class="keyword">private</span> Listener2 listener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于为authority赋值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomNameResolver</span><span class="params">(String authority)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authority = authority;</span><br><span class="line">        consul = Consul.builder().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//authority 概念 服务器集群的名字 grpc-server</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServiceAuthority</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authority;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       listener 中文 叫做监听</span></span><br><span class="line"><span class="comment">       start方法中我们要周期的发起对于名字解析的请求，获取最新的服务列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(Listener2 listener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.listener = listener;</span><br><span class="line">        scheduledThreadPoolExecutor.scheduleAtFixedRate(<span class="built_in">this</span>::resolve, <span class="number">10</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定期完成的工作 就是在resolve中处理的</span></span><br><span class="line">    <span class="comment">//完成解析的工作</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resolve</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;开始解析 服务.... &#123;&#125; &quot;</span>, <span class="built_in">this</span>.authority);</span><br><span class="line">        <span class="comment">//1  获取所有的健康服务 grpc-server</span></span><br><span class="line">        <span class="comment">//把所有的健康服务的 ip+port封装 InetSocketAddress</span></span><br><span class="line">        List&lt;InetSocketAddress&gt; addressList = getAddressList(<span class="built_in">this</span>.authority);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (addressList == <span class="literal">null</span> || addressList.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;解析存在问题：&#123;&#125; 失败.....&quot;</span> + <span class="built_in">this</span>.authority);</span><br><span class="line">            <span class="built_in">this</span>.listener.onError(Status.UNAVAILABLE.withDescription(<span class="string">&quot;没有可用的节点....&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 负载均衡 gprc 把所健康服务 封装 EquivalentAddressGroup &#123;address:port&#125;</span></span><br><span class="line">        <span class="comment">// InetSocketAddress ---&gt; EquivalentAddressGroup</span></span><br><span class="line">        List&lt;EquivalentAddressGroup&gt; equivalentAddressGroups = addressList.stream()</span><br><span class="line">                .map(EquivalentAddressGroup::<span class="keyword">new</span>)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 命名解析完成 ResultionResult</span></span><br><span class="line">        <span class="type">ResolutionResult</span> <span class="variable">resolutionResult</span> <span class="operator">=</span> ResolutionResult.newBuilder()</span><br><span class="line">                .setAddresses(equivalentAddressGroups)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//监听名字解析的结果</span></span><br><span class="line">        <span class="built_in">this</span>.listener.onResult(resolutionResult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;InetSocketAddress&gt; <span class="title function_">getAddressList</span><span class="params">(String authority)</span> &#123;</span><br><span class="line">        <span class="type">HealthClient</span> <span class="variable">healthClient</span> <span class="operator">=</span> consul.healthClient();</span><br><span class="line">        ConsulResponse&lt;List&lt;ServiceHealth&gt;&gt; response = healthClient.getHealthyServiceInstances(authority);</span><br><span class="line"></span><br><span class="line">        List&lt;ServiceHealth&gt; healthList = response.getResponse();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> healthList.stream()</span><br><span class="line">                .map(ServiceHealth::getService)</span><br><span class="line">                .map(service -&gt; <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(service.getAddress(), service.getPort()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        scheduledThreadPoolExecutor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>CustomNameResolverProvider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomNameResolverProvider</span> <span class="keyword">extends</span> <span class="title class_">NameResolverProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> NameResolver <span class="title function_">newNameResolver</span><span class="params">(URI targetUri, NameResolver.Args args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomNameResolver</span>(targetUri.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//优先级应该高于DNS（5）命名服务</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">priority</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//名字解析 （注册中心）通信的协议 consul</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDefaultScheme</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;consul&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//作用：告知Grpc 自定义的ResolverProvider生效</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAvailable</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>grpc客户端的开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 原有的开发方式保留</span><br><span class="line"><span class="number">2.</span> 引入自定义名字解析</span><br><span class="line"><span class="number">3.</span> 引入负载均衡的算法 </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NameResolverGrpcClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//1 引入新的命名解析</span></span><br><span class="line">        NameResolverRegistry.getDefaultRegistry().register(<span class="keyword">new</span> <span class="title class_">CustomNameResolverProvider</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2客户端的开发</span></span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">managedChannel</span> <span class="operator">=</span> ManagedChannelBuilder.forTarget(<span class="string">&quot;grpc-server&quot;</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                <span class="comment">//3 引入负载均衡算法 round_robin轮训 负载均衡</span></span><br><span class="line">                .defaultLoadBalancingPolicy(<span class="string">&quot;round_robin&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 获得stub对象进行调用</span></span><br><span class="line">        <span class="comment">//模拟发送4次请求</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            sendRequest(managedChannel, i);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        managedChannel.awaitTermination(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendRequest</span><span class="params">(ManagedChannel managedChannel, <span class="type">int</span> idx)</span> &#123;</span><br><span class="line">        HelloServiceGrpc.<span class="type">HelloServiceBlockingStub</span> <span class="variable">helloServiceBlockingStub</span> <span class="operator">=</span> HelloServiceGrpc.newBlockingStub(managedChannel);</span><br><span class="line">        HelloProto.<span class="type">HelloRespnose</span> <span class="variable">helloRespnose</span> <span class="operator">=</span> helloServiceBlockingStub.hello(HelloProto.HelloRequest.newBuilder().setName(<span class="string">&quot;xiaohei &quot;</span> + idx).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;helloRespnose.getResult() = &quot;</span> + helloRespnose.getResult());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">遗憾：内部集群名字的拼接有问题</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ul>
<li><p>服务器坑</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在原始的gRPC与consul进行服务注册时，会产生一个Http2Connection异常。</span><br><span class="line">原因：</span><br><span class="line">   进行健康汇报检查时，consul代码会通过.check(Registration.RegCheck.tcp(address + &quot;:&quot; + port, 10))，向grpc-server发起访问，如果这个访问没有问题，则上报consul服务器，这样就完成了健康的检测。但是在.check(Registration.RegCheck.tcp(address + &quot;:&quot; + port, 10))向grpc-server发请求时，站在grpc-server的角度，他会认为这是一个普通的客户端方法，他需要建立Http2连接，而consul的客户端代码，是不支持http2协议，无法建立Http2的连接，所以就抛出Http2ConnectionHandler Broken pipe。</span><br><span class="line">注意：</span><br><span class="line"><span class="bullet">   1.</span> 这个异常不会影响到我们目前程序的运行。</span><br><span class="line"><span class="bullet">   2.</span> 不能为了取消这个异常，而不使用 .check(Registration.RegCheck.tcp(address + &quot;:&quot; + port, 10))。</span><br><span class="line"><span class="bullet">   3.</span> gRPC+consul+springboot ---&gt; springcloud</span><br><span class="line"><span class="code">      健康检查 springboot actuator进行整合 而不采用.check(Registration.RegCheck.tcp(address + &quot;:&quot; + port, 10))。</span></span><br><span class="line"><span class="code">      这样也就不会出现这个异常了。</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="6-3-4-Grpc与SpringBoot整合的高级应用"><a href="#6-3-4-Grpc与SpringBoot整合的高级应用" class="headerlink" title="6.3.4 Grpc与SpringBoot整合的高级应用"></a>6.3.4 Grpc与SpringBoot整合的高级应用</h6><ul>
<li><p>拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 开发一个拦截器 </span><br><span class="line">   xxxxInterceptor  <span class="keyword">implements</span> <span class="title class_">ClientInterceptor</span> </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomBootInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ClientInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; <span class="title function_">interceptCall</span><span class="params">(MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是拦截器 起作用了....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> next.newCall(method, callOptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2.</span> 引入拦截器</span><br><span class="line"> <span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomBootInterceptorConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Bean 让spring容器 认识这个Bean ,那Spring容器会不会把他当成grpc的拦截器呢？</span></span><br><span class="line">    <span class="meta">@GrpcGlobalClientInterceptor</span></span><br><span class="line">    <span class="keyword">public</span> CustomBootInterceptor <span class="title function_">customBootInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomBootInterceptor</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 第二种引入拦截器的方式</span><br><span class="line">  <span class="meta">@GrpcGlobalClientInterceptor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomBootInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ClientInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; <span class="title function_">interceptCall</span><span class="params">(MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是拦截器 起作用了....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> next.newCall(method, callOptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>consul注册中心[grpc替换 springcloud中 openFeign]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 服务器端开发 【nacos,zookeeper】</span><br><span class="line">   <span class="number">1.</span> 依赖 </span><br><span class="line">      &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">3.1</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">       </span><br><span class="line">       &lt;!--健康检查  http协议 --&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-actuator&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    <span class="number">2.</span> application.yml</span><br><span class="line">     </span><br><span class="line">        spring:</span><br><span class="line">          application:</span><br><span class="line">            name: boot-server</span><br><span class="line">          cloud:</span><br><span class="line">            consul:</span><br><span class="line">              discovery:</span><br><span class="line">                register: <span class="literal">true</span></span><br><span class="line">                hostname: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">                port: <span class="number">8500</span></span><br><span class="line">                heartbeat:</span><br><span class="line">                  enabled: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        #  main:</span><br><span class="line">        #    web-application-type: none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        grpc:</span><br><span class="line">          server:</span><br><span class="line">            port: <span class="number">9000</span></span><br><span class="line">     </span><br><span class="line">    <span class="number">3.</span> 启动类</span><br><span class="line">         <span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"></span><br><span class="line">    注意事项：</span><br><span class="line">          <span class="number">1.</span> 进行健康检查 heartbeat.enabled = <span class="literal">true</span></span><br><span class="line">          <span class="number">2.</span> 服务端做集群</span><br><span class="line">          <span class="number">3.</span> 替换注册中心（consul zk nacos）</span><br><span class="line">             https:<span class="comment">//github.com/yidongnan/grpc-spring-boot-starter</span></span><br><span class="line">             <span class="number">1.</span> 替换cloud 依赖jar</span><br><span class="line">             <span class="number">2.</span> application.yml</span><br><span class="line">                ip+port </span><br><span class="line">              </span><br><span class="line"><span class="number">2.</span> 客户端开发</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">3.1</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--健康检查  http协议 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-actuator&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        application.yml</span><br><span class="line">          grpc:</span><br><span class="line">            client:</span><br><span class="line">              cloud-grpc-server:</span><br><span class="line">                address: <span class="string">&#x27;discovery://boot-server&#x27;</span></span><br><span class="line">                negotiation-type: plaintext</span><br><span class="line">                enable-keep-alive: <span class="literal">true</span></span><br><span class="line">                keep-alive-without-calls: <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        通过这个注解进行注入：</span><br><span class="line">              <span class="meta">@GrpcClient(&quot;cloud-grpc-server&quot;)</span></span><br></pre></td></tr></table></figure></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Michael</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/03/22/Rpc/">http://example.com/2023/03/22/Rpc/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Michael的小木屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="http:///p0.qhimg.com/t011e52abaa7f71c4b7.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/03/24/redis/"><img class="prev-cover" src="http:///p1.qhimg.com/t01a7e20297ee92fdd5.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/11/Spring%E6%95%B4%E5%90%88%E4%B8%8E%E4%BA%8B%E5%8A%A1/"><img class="next-cover" src="http:///p8.qhimg.com/t010e646cdb35ad81e0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring（4）</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Michael</div><div class="author-info__description">后端学徒，记录学习</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">30</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zyzstart" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/1738091590@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E5%88%97%E8%AF%BE%E7%A8%8B%E2%80%93RPC%E7%BC%96%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">分布式系列课程–RPC编程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BC%95%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">1. 引言</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-RPC%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 RPC的概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 架构的演变过程</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">1. 单体架构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">2. 单体架构存在的问题</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E5%9E%82%E7%9B%B4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">3. 垂直架构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-RPC%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">4. RPC架构</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5-RPC%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">5. RPC的设计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Hessian-RPC"><span class="toc-number">1.2.</span> <span class="toc-text">2. Hessian RPC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-HessianRPC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 HessianRPC概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-HessianRPC%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 HessianRPC设计思想</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-HessianRPC%E7%9A%84%E5%BC%80%E5%8F%91"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3 HessianRPC的开发</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">2.3.1 环境搭建</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-3-2-%E5%BC%80%E5%8F%91%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.3.2 开发步骤</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-HessianRPC%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.4 HessianRPC核心源码分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-5-Hessian-%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.5 Hessian 序列化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Thrift-RPC"><span class="toc-number">1.3.</span> <span class="toc-text">3. Thrift RPC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-ThriftRPC%E7%9A%84%E5%BC%95%E8%A8%80"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 ThriftRPC的引言</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-ThriftRPC-%E7%89%B9%E7%82%B9"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">3.1.1 ThriftRPC 特点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-ThriftRPC-%E6%A1%86%E6%9E%B6"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">3.1.1 ThriftRPC 框架</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-2-ThriftRPC%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">3.1.2 ThriftRPC安装</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-3-IDL%E8%AF%AD%E6%B3%95"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">3.1.3 IDL语法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-4-Thrift-RPC%E7%9A%84%E5%BC%80%E5%8F%91"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">3.1.4 Thrift RPC的开发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-5-%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E6%80%9D%E8%80%83"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">3.1.5 实战开发中的思考</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-6TServer%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">3.1.6TServer服务的相关内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-gRPC"><span class="toc-number">1.4.</span> <span class="toc-text">4. gRPC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-gRPC%E7%AE%80%E4%BB%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 gRPC简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-Http2-0%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 Http2.0协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-3-Protocol-Buffers-protobuf"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3 Protocol Buffers [protobuf]</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-1-protobuf%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">4.3.1 protobuf编译器的安装</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-2-protobuf-IDEA%E7%9A%84%E6%8F%92%E4%BB%B6"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">4.3.2 protobuf IDEA的插件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-3protobuf%E7%9A%84%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">4.3.3protobuf的语法详解</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-4-%E7%AC%AC%E4%B8%80%E4%B8%AAgPRC%E7%9A%84%E5%BC%80%E5%8F%91"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">4.3.4 第一个gPRC的开发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-5gRpc%E7%9A%84%E5%9B%9B%E7%A7%8D%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">4.3.5gRpc的四种通信方式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-3-6-gPRC%E4%BB%A3%E7%90%86%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">4.3.6 gPRC代理方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-gPRC%E4%B8%8ESpringBoot%E6%95%B4%E5%90%88"><span class="toc-number">1.5.</span> <span class="toc-text">5. gPRC与SpringBoot整合</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-gRPC%E5%92%8CSpringBoot%E6%95%B4%E5%90%88%E7%9A%84%E6%80%9D%E6%83%B3"><span class="toc-number">1.5.1.</span> <span class="toc-text">5.1 gRPC和SpringBoot整合的思想</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#SpringBoot%E4%B8%8EGRPC%E6%95%B4%E5%90%88%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD-%E5%AF%B9%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%E5%B0%81%E8%A3%85"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">SpringBoot与GRPC整合的过程中 对于服务端做了什么封装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-gPRC%E7%9A%84%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text">6. gPRC的高级应用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.6.1.</span> <span class="toc-text">6.1 拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#6-1-1-%E4%B8%80%E5%85%83%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">6.1.1 一元拦截器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-1-2-%E6%B5%81%E5%BC%8F%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">6.1.2 流式拦截器</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%87%8D%E8%AF%95"><span class="toc-number">1.6.2.</span> <span class="toc-text">6.2 客户端重试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-%E5%91%BD%E5%90%8D%E8%A7%A3%E6%9E%90-NameResovler"><span class="toc-number">1.6.3.</span> <span class="toc-text">6.3 命名解析 NameResovler</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#6-3-1-Consul"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">6.3.1 Consul</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-3-2-Consul-Java%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">6.3.2 Consul Java客户端开发注册中心</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-3-3-Grpc%E4%B8%ADConsul%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%BC%80%E5%8F%91"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">6.3.3 Grpc中Consul注册中心的开发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-3-4-Grpc%E4%B8%8ESpringBoot%E6%95%B4%E5%90%88%E7%9A%84%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="toc-number">1.6.3.4.</span> <span class="toc-text">6.3.4 Grpc与SpringBoot整合的高级应用</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/04/20/DDIA%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="DDIA阅读"><img src="http:///p0.qhimg.com/t015815bdb897cdb6ce.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DDIA阅读"/></a><div class="content"><a class="title" href="/2024/04/20/DDIA%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="DDIA阅读">DDIA阅读</a><time datetime="2024-04-19T16:00:00.000Z" title="发表于 2024-04-20 00:00:00">2024-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/20/%E5%87%A4%E5%87%B0%E6%9E%B6%E6%9E%84%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="凤凰架构读书笔记"><img src="http:///p4.qhimg.com/t0196dfad56317fe205.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="凤凰架构读书笔记"/></a><div class="content"><a class="title" href="/2024/04/20/%E5%87%A4%E5%87%B0%E6%9E%B6%E6%9E%84%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" title="凤凰架构读书笔记">凤凰架构读书笔记</a><time datetime="2024-04-19T16:00:00.000Z" title="发表于 2024-04-20 00:00:00">2024-04-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/24/kafka/" title="Kafka"><img src="http:///p3.qhimg.com/t01e2fa62f505895db7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kafka"/></a><div class="content"><a class="title" href="/2023/11/24/kafka/" title="Kafka">Kafka</a><time datetime="2023-11-23T16:00:00.000Z" title="发表于 2023-11-24 00:00:00">2023-11-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/17/Netty2/" title="Netty（下）"><img src="http:///p2.qhimg.com/t010ad2c94c7a13a383.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty（下）"/></a><div class="content"><a class="title" href="/2023/10/17/Netty2/" title="Netty（下）">Netty（下）</a><time datetime="2023-10-16T16:00:00.000Z" title="发表于 2023-10-17 00:00:00">2023-10-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/17/Netty1/" title="Netty（上）"><img src="http:///p9.qhimg.com/t0163fa31dd6351bf12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty（上）"/></a><div class="content"><a class="title" href="/2023/10/17/Netty1/" title="Netty（上）">Netty（上）</a><time datetime="2023-10-16T16:00:00.000Z" title="发表于 2023-10-17 00:00:00">2023-10-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('http:///p0.qhimg.com/t011e52abaa7f71c4b7.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By Michael</div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>